(()=>{var ot=Object.defineProperty;var rt=(r,t)=>{for(var e in t)ot(r,e,{get:t[e],enumerable:!0})};function f(r){return r?typeof r=="object"?JSON.parse(JSON.stringify(r)):r:r??null}function v(r,t="",e){let s=t.split("."),o;try{for(o=0;o<s.length-1;o++)r=r[s[o]];return r[s[o]]=e!==void 0?e:null,r[s[o]]}catch{}}async function b(r,t){if(typeof r=="function"){let e=r();return!(e instanceof Promise)||t?.aborted?void 0:(await(async()=>t?t.aborted?void 0:await Promise.race([e,new Promise(n=>t.addEventListener("abort",()=>n()))]):await e)())?.default}return r}function O(r,t){for(let[e,s]of r)if(Array.isArray(s)){let o=s.indexOf(t);o!==-1&&(s.length===1?r.delete(e):s.splice(o,1))}else s===t&&r.delete(e)}function j(r){function t(a){let p=document.createElement("capsule");return p.innerHTML=a,p}function e(a){let p=a.querySelectorAll("script");for(let c of p)c.remove()}function s(a,p){let c=p.replace(/\s+/g,"").toLowerCase();if(["src","href","xlink:href"].includes(a)&&(c.includes("javascript:")||c.includes("data:text/html"))||a.startsWith("on"))return!0}function o(a){let p=a.attributes;for(let{name:c,value:m}of p)s(c,m)&&a.removeAttribute(c)}function n(a){let p=a.children;for(let c of p)o(c),n(c)}let i=t(r);return e(i),n(i),i.childNodes}var L=()=>{let r=[],t=!1,e=()=>r.length,s=()=>r.length===0,o=i=>{r.push(i),t||(t=!0,n())},n=async()=>{let i=r.at(0);i?(await i(),r.shift(),n()):t=!1};return{add:o,isEmpty:s,size:e}};var h=(r="root",t,e="")=>{};var P=class{constructor(t,e,s){this.component=t,this.app=e,this.proxiesData={},this.context={app:e,phase:0,abortSignal:s,options:t,container:null,node:{},param:{},method:{},proxy:{},source:t.sources||{}}}async loaded(t){if(this.component.loaded)return await this.component.loaded.bind(this.context)(t)}async rendered(){if(typeof this.component!="object")return h(this.context.container.nodepath,211);if(this.component.rendered)return await this.component.rendered.bind(this.context)()}async created(){if(this.component.created)return await this.component.created.bind(this.context)()}methods(){if(this.component.methods)for(let[t,e]of Object.entries(this.component.methods))this.context.method[t]=e.bind(this.context);Object.preventExtensions(this.context.method)}params(){if(this.component.params){for(let t in this.component.params)if(t in this.context.param)return h(this.context.container.nodepath,213,t);Object.assign(this.context.param,f(this.component.params))}Object.preventExtensions(this.context.param)}proxies(){if(this.component.proxies)for(let t in this.component.proxies){if(t in this.proxiesData)return h(this.context.container.nodepath,214,t);this.proxiesData[t]=this.component.proxies[t]}this.context.proxy=this.getProxy(),Object.preventExtensions(this.context.proxy)}};function C(r,t,e=""){if(!(r&&(r.constructor.name==="Object"||r.constructor.name==="Array")))return r;let s={getPrototypeOf(o){return{target:o,instance:"Proxy"}},get(o,n,i){return typeof n=="symbol"||t.get?.(o,`${e}${n}`),Reflect.get(o,n,i)},set(o,n,i,a){if(typeof n=="symbol")return Reflect.set(o,n,i,a);let p=!1;return t.beforeSet(i,`${e}${n}`,m=>{i=m,p=!0})||!(Reflect.get(o,n,a)!==i||n==="length"||p)||(i=C(i,t,`${e}${n}.`),Reflect.set(o,n,i,a),t.set(o,i,`${e}${n}`)),!0},deleteProperty(o,n){return Reflect.deleteProperty(o,n)},defineProperty(o,n,i){return Reflect.defineProperty(o,n,i)}};r=f(r);for(let o in r)r[o]=C(r[o],t,`${e}${o}.`);return new Proxy(r,s)}function N(r,t,e){if(!r)return;let s=(o,n)=>{let i=Math.min(o.length,n.length);return o.slice(0,i)===n.slice(0,i)};for(let[o,n]of r)Array.isArray(n)?n.includes(t)&&o(e):s(t,n)&&o(e,t.length>n.length?t.replace(n+".",""):void 0)}var _={};rt(_,{_attr:()=>Q,_class:()=>B,_evalHTML:()=>J,_event:()=>Y,_html:()=>I,_text:()=>X});var I={update:(r,t)=>{r.innerHTML="",t&&r.append(...j(t))}};var J={update:(r,t)=>t!==void 0?r.innerHTML=t:""};var B={update:(r,t,e)=>t?r.classList.add(e):r.classList.remove(e)};var X={update:(r,t)=>r.textContent=t!==Object(t)?t:JSON.stringify(t)};var Q={update:(r,t,e)=>{typeof t=="boolean"?t?r.setAttribute(e,""):r.removeAttribute(e):r.setAttribute(e,t)}};var Y={create:(r,t)=>{for(let e in t)r.addEventListener(e,t[e])},destroy:(r,t)=>{for(let e in t)r.removeEventListener(e,t[e])}};var x=(r,t,e="")=>{};var G={refs:[],collect:!1,define(r){return r&&this.refs.every(t=>t.startsWith(this.refs.at(0)))?this.refs.at(-1):[...this.refs]},clear(){this.collect=!1,this.refs.length=0}};var $=class extends P{constructor(t,e,s,o){super(t,e,s),this.Nodes=o,this.impress=G,this.context={...this.context,directives:{..._,...e.directives,...t.directives}}}async props(){}async mounted(){this.component.mounted&&await this.component.mounted.bind(this.context)()}getProxy(){return C(this.proxiesData,{beforeSet:(t,e,s)=>{if(this.component.setters?.[e]){let o=this.component.setters[e].bind(this.context)(t);if(o===void 0)return!0;s(o)}},set:(t,e,s)=>{for(let o in this.context.node){let n=this.context.node[o];N(n.reactivity.node,s),N(n.reactivity.component,s,e);for(let i in n.section)N(n.section[i]?.reactivity.component,s,e)}this.component.handlers?.[s]?.bind(this.context)(e)},get:(t,e)=>{this.impress.collect&&!this.impress.refs.includes(e)&&this.impress.refs.push(e)}})}async nodes(){if(this.component.nodes){let t=this.component.nodes.bind(this.context)(),e=this.context.container;for await(let[s,o]of Object.entries(t)){let n=o.selector||this.context.selector||`.${s}`,i=typeof n=="function"?n(s):n,a=e.querySelector(i)||e.classList.contains(s)&&e,p=e.nodepath?e.nodepath+"."+s:s;if(a){if(a.nodepath=p,a.nodename=s,Object.assign(this.context.node,{[s]:a}),o){let c=new this.Nodes(o,this.context,a,this.impress,this.app,s);for await(let[m]of Object.entries(o))await c.controller(m)}}else x(p,105)}Object.preventExtensions(this.context.node)}}};var d=(r="root",t,e,s,o="")=>{};var W=class{constructor(t,e,s){this.props=t,this.context=e,this.container=e.container,this.app=s}async setup(t){if(this.props.proxies&&Object.keys(this.props.proxies).length&&!t?.proxies)return d(this.container.nodepath,306);if(this.container.proxy||(this.container.proxy={}),t)return await this.params(t.params),await this.methods(t.methods),await this.proxies(t.proxies)}validation(t,e,s,o,n){let i=this.container.nodepath,a=(u,l)=>u&&l&&!(typeof u===l||l==="array"&&Array.isArray(u))&&d(i,n,s,304,l),p=(u,l)=>u&&Array.isArray(l)&&!l.includes(u)&&d(i,n,s,302,u),c=(u,l)=>u??(l.required&&d(i,n,s,303))??l.default,m=(u,l)=>typeof l=="string"?a(u,l):(a(u,l.type),p(u,l.enum),c(u,l));return{string:()=>a(o,e),object:()=>{o=m(o,e),e.validate?.(o,m)},function:()=>e(o,m)}[typeof e]?.(),t[s]=o,m}async proxies(t){if(t){let e={},s=this.context;for(let o in t){let n=t[o],i=null;this.container.proxy[o]={getValue:()=>f(s.proxy[o]),setValue:(c,m)=>{m?(v(s.proxy[o],m,f(c)),n.validate?.(s.proxy[o],i)):this.validation(s.proxy,n,o,f(c),"proxies")}};let a=null,{store:p}=n;if(this.props.proxies&&o in this.props.proxies)a=this.props.proxies[o];else if(p){let c=await this.app.store?.init(p);if(!c)return d(this.container.nodepath,"proxies",o,307,p);a=c.proxies(o,this.container)}i=this.validation(e,n,o,f(a),"proxies")}return e}}async params(t){for(let e in t){let s=t[e],o=async()=>{let{store:n}=s,i=null;if(n){let a=await this.app.store?.init(n);if(!a)return d(this.container.nodepath,"params",e,307,n);i=a.params(e)}else i=this.props?.params[e];return s?.ignore?i:f(i)};this.validation(this.context.param,s,e,await o(),"params"),s.readonly&&Object.defineProperty(this.context.param,e,{writable:!1})}}async methods(t){for(let e in t){let s=t[e],{store:o}=s;if(o){let n=await this.app.store?.init(o);if(!n)return d(this.container.nodepath,"methods",e,307,o);let i=n.methods(e);if(!i)return d(this.container.nodepath,"methods",e,305,o);this.context.method[e]=async(...a)=>f(await i(...f(a)))}else{let n=this.props.methods&&e in this.props.methods;if(s?.required&&!n)return d(this.container.nodepath,"methods",e,303);n&&(this.context.method[e]=async(...i)=>f(await this.props.methods[e](...f(i))))}}}},K={async init(r,t,e,s){return await new W(r,e,s).setup(t)}};var V=class extends ${constructor(...t){super(...t)}async props(){this.proxiesData=await K.init(this.context.options.inputs,this.component.props,this.context,this.app)||{}}destroy(t){t.reactivity?.component?.clear(),delete t.proxy;for(let e in t.unstore)t.unstore[e]()}unmount(t){if(this.context.node)for(let e of Object.values(this.context.node)){if(e.unmount&&!e.hasAttribute("iterable")){if(e.section)for(let s of Object.values(e.section))s.unmount&&s.unmount();e.unmount()}if(e.directives)for(let s of Object.values(e.directives))s.destroy&&s.destroy();e.reactivity?.node?.clear()}this.component.unmounted&&this.component.unmounted.bind(this.context)(),delete t.unmount}};function U(r){if(r.mixins?.length){let t=["selectors","directives","params","proxies","methods","handlers","setters","sources"],e=["params","proxies","methods"],s=["loaded","rendered","created","mounted","unmounted"],o={props:{}},n=(a,p,c)=>({...a[c],...p[c]}),i=a=>{o.template=a.template||o.template,t.forEach(c=>{o[c]=n(o,a,c)}),s.forEach(c=>{let m=o[c];o[c]=async function(){return a[c]?.bind(this)()||m?.bind(this)()}}),e.forEach(c=>{o.props[c]=n(o.props,a.props||{},c)});let p=o.nodes;o.nodes=function(){return{...p?.bind(this)(),...a.nodes?.bind(this)()}}};return r.mixins.forEach(a=>{i(U(a))}),i(r),o}return r}var y=class{constructor(t,e,s,o,n,i){this.app=n,this.node=t,this.context=e,this.impress=o,this.nodeElement=s,this.keyNode=i,this.nodeElement.reactivity={node:new Map}}reactive(t,e,s){t?.length&&s.set(e,t),this.impress.clear()}reactiveNode(t,e){this.reactive(t,e,this.nodeElement.reactivity.node)}};var Z={collect(r,t,e){return{params:this.params(r.params,t,e),methods:this.methods(r.methods),section:r.section}},methods(r){let t={};if(r)for(let[e,s]of Object.entries(r))typeof s=="function"&&Object.assign(t,{[e]:s});return t},params(r,t,e){let s={};if(r)for(let[o,n]of Object.entries(r)){let i=null;typeof n=="function"&&n.name?i=t?n(t,e):n():i=n,Object.assign(s,{[o]:i})}return s}};async function tt(r,t,e,s,o){if(r.sections){let n=async(i,a)=>{if(r.iterate)return h(e.section[i].nodepath,204);e.section[i].unmount?.(),a.src&&(a.section=i,await o(t,e,a,()=>s(a.proxies,e.section[i],i)))};e.section={};for await(let[i,a]of Object.entries(r.sections)){if(a.induce||a.iterate||a.sections)return h(e.section[i].nodepath,215);let p=e.querySelector(`[section="${i}"]`);if(!p)return h(e.nodepath,201,i);p.reactivity||(p.reactivity={component:new Map}),Object.assign(e.section,{[i]:p}),a.src&&await n(i,a),p.mount=async c=>await n(i,c||a)}}}var w=class extends y{constructor(...t){super(...t),this.nodeElement.reactivity.component=new Map}reactiveComponent(t,e,s){let o=s||this.nodeElement;this.reactive(t,e,o.reactivity.component)}reactivate(t,e,s,o,n){let i={};if(t)for(let[a,p]of Object.entries(t))if(typeof p=="function"&&p.name){this.impress.collect=!0;let c=s&&p.length?p(s[o],o):p(n);Object.assign(i,{[a]:c}),e(a,p),this.impress.clear()}else Object.assign(i,{[a]:p});return i}async create(t,e,s,o,n,i){let{src:a,abortSignal:p,aborted:c,sections:m,ssr:E}=s;if(!a)return h(e.nodepath,203);let u=null;e.process||(e.process=!0,u=await M(a,e,{abortSignal:p,aborted:c,sections:m,ssr:E,...Z.collect(s,n,i),proxies:o()||{}},this.app),delete e.process),u&&await tt(s,t,u,(l,A,F)=>i!==void 0?t(l,u.section[F],i):t(l,A),this.create.bind(this))}};var R=class extends w{constructor(...t){super(...t),this.queue=L(),this.name=null,this.created=!1,this.nodeElement.toEmpty=()=>this.remove.bind(this)(0)}async init(){if(typeof this.node.component.iterate!="function")return h(this.nodeElement.nodepath,205);if(this.createIterate=async t=>{this.created||(this.nodeElement.style.visibility="hidden");let e=()=>this.proxies(this.node.component.proxies,this.nodeElement.children[t],t);if(await this.create(this.proxies.bind(this),this.nodeElement,this.node.component,e,this.data[t],t),!this.created){if(this.nodeElement.children.length>1)return h(this.nodeElement.nodepath,210);this.nodeElement.style.removeProperty("visibility")}this.created=!0},this.impress.collect=!0,this.data=this.node.component.iterate(),this.data){if(!Array.isArray(this.data))return h(this.nodeElement.nodepath,206);this.name=this.impress.refs.at(-1),this.impress.clear(),this.nodeElement.setAttribute("iterate",""),Object.getPrototypeOf(this.data).instance==="Proxy"&&(this.reactiveComponent([this.name],e=>{this.data=this.node.component.iterate(),e.length&&this.queue.add(()=>{if(this.node.component.proxies){for(let[s,o]of Object.entries(this.node.component.proxies))if(typeof o=="function"&&o.name&&o.length)for(let n=0;n<Math.min(this.nodeElement.children.length,e.length);n++){let i=o(this.data[n],n);this.nodeElement.children[n].proxy[s]?.setValue(i),this.sections(this.node.component.sections,this.nodeElement.children[n],n)}}}),this.queue.add(async()=>await this.length(e.length))}),this.reactiveComponent([this.name+".length"],e=>{this.queue.add(async()=>await this.length(e))}));let t=async()=>await this.add(this.data.length);if(this.nodeElement.induce=async e=>e?await t():this.nodeElement.toEmpty(),this.node.component.induce){if(typeof this.node.component.induce!="function")return h(this.nodeElement.nodepath,212);this.impress.collect=!0;let e=this.node.component.induce();this.reactiveNode(this.impress.define(),async()=>await this.nodeElement.induce(this.node.component.induce())),e&&await t()}else await t()}}sections(t,e,s){if(t)for(let[o,n]of Object.entries(t))for(let[i,a]of Object.entries(n.proxies))typeof a=="function"&&a.name&&a.length&&(e.section[o]?.proxy[i]?.setValue(a(this.data[s],s)),this.sections(n.sections,e.section[o],s))}proxies(t,e,s){let o=(n,i)=>{this.impress.refs.some(a=>a.includes(this.name))?this.reactiveComponent(this.impress.define(n),(a,p)=>{this.queue.add(async()=>{if(p)this.nodeElement.children[s]?.proxy[n]?.setValue(a,p);else if(this.data=this.node.component.iterate(),s<this.data.length){let c=i(this.data[s],s);this.nodeElement.children[s]?.proxy[n]?.setValue(c)}})},e):this.created?this.impress.clear():this.reactiveComponent(this.impress.define(n),(a,p)=>{!this.nodeElement.process&&this.queue.add(()=>{for(let c=0;c<this.nodeElement.children.length;c++)p?this.nodeElement.children[c].proxy[n]?.setValue(a,p):this.nodeElement.children[c].proxy[n]?.setValue(i(this.data[c],c))})},e)};return this.reactivate(t,o,this.data,s)}async length(t){if(this.data=this.node.component.iterate(),this.data.length===t){let e=this.nodeElement.children.length;t>e&&await this.add(t),t<e&&await this.remove(t)}}async add(t){let e=this.nodeElement.children.length;for(;t>e;)await this.createIterate(e),e++}remove(t){let e=this.nodeElement.children.length;for(;t<e;)e--,O(this.nodeElement.reactivity.component,this.name+"."+e),this.nodeElement.children[e].unmount()}};var S=class extends w{constructor(...t){super(...t)}async init(){let t=async e=>await this.create(this.proxies.bind(this),this.nodeElement,e,()=>this.proxies(e.proxies,this.nodeElement));if(this.nodeElement.induce=async e=>{e?this.nodeElement.unmount||await t(this.node.component):this.nodeElement.unmount?.()},this.node.component.induce){if(typeof this.node.component.induce!="function")return h(this.nodeElement.nodepath,212);this.impress.collect=!0;let e=this.node.component.induce();this.reactiveNode(this.impress.define(),async()=>await this.nodeElement.induce(this.node.component.induce())),e&&await t(this.node.component)}else this.node.component.src&&await t(this.node.component)}proxies(t,e){let s=(o,n)=>this.reactiveComponent(this.impress.define(o),(i,a)=>a?e.proxy[o]?.setValue(i,a):e.proxy[o]?.setValue(n()),e);return this.reactivate(t,s,null,null,e)}};var T=class extends y{constructor(...t){super(...t)}init(t){let e=this.nodeElement;if(!t.startsWith("_"))return x(e.nodepath,102,t);let s=this.context.directives[t],o=this.node[t],{create:n,update:i,destroy:a}=s;e.hasOwnProperty("directives")||Object.assign(e,{directives:{}}),Object.assign(e.directives,{[t]:{create:()=>n?n.bind(s)(e,o):{},destroy:()=>a?a.bind(s)(e,o):{}}}),n&&e.directives[t].create();let p=(c,m,E)=>{let u=l=>i.bind(s)(e,l,m,E);typeof c=="function"?(this.impress.collect=!0,u(c(e)),this.reactiveNode(this.impress.define(),()=>u(c(e)))):u(c)};if(i)if(typeof o=="object")for(let c in o)p(o[c],c,o);else p(o)}};var q=class extends y{constructor(...t){super(...t)}listeners(t){typeof this.node[t]=="function"&&(this.nodeElement[t]=e=>this.node[t].bind(this.context)(e,this.nodeElement))}general(t){if(t==="innerHTML")return x(this.nodeElement.nodepath,106);if(typeof this.node[t]=="function"){let e=()=>{let s=this.node[t].bind(this.context)(this.nodeElement);this.nodeElement[t]!==null&&typeof this.nodeElement[t]=="object"?s!==null&&typeof s=="object"?Object.assign(this.nodeElement[t],s):x(this.nodeElement.nodepath,103,t):this.nodeElement[t]=s};this.impress.collect=!0,e(),this.reactiveNode(this.impress.define(),e)}else this.nodeElement[t]=this.node[t]}init(t){t.startsWith("on")?this.listeners(t):this.general(t)}};var g=class{constructor(t,e,s,o,n,i){this.app=n,this.node=t,this.context=e,this.impress=o,this.nodeElement=s,this.keyNode=i,this.native=new q(t,e,s,o,n,i),this.directive=new T(t,e,s,o,n,i)}async controller(t){t in this.nodeElement?this.native.init(t):t in this.context.directives?this.directive.init(t):t==="component"&&this.component?await this.component():t!=="selector"&&x(this.nodeElement.nodepath,104,t)}};var H=class extends g{constructor(...t){super(...t)}async component(){if(this.nodeElement.hasAttribute("section"))return h(this.nodeElement.nodepath,207);if(this.nodeElement.hasAttribute("iterable"))return h(this.nodeElement.nodepath,208);let{node:t,context:e,nodeElement:s,impress:o,app:n,keyNode:i}=this;this.node.component.iterate?await new R(t,e,s,o,n,i).init():await new S(t,e,s,o,n,i).init()}};function k(r,t,e,s){let o={...t.context.options};if(e){let n=r.section[e];return n?(s||(n.innerHTML=o.template),n.nodepath=r.nodepath+"."+e,n.nodename=e,n.unmount=()=>{t.destroy(n),t.unmount(n),n.innerHTML=""},n):h(r.nodename,202,e)}else{if(r.hasAttribute("iterate")){if(!o.template)return h(r.nodepath,209);s||r.insertAdjacentHTML("beforeEnd",o.template);let n=r.children[r.children.length-1];return n.nodepath=r.nodepath,r.unmount||(r.unmount=()=>{t.destroy(r),r.toEmpty(),delete r.unmount}),n.setAttribute("iterable",""),n.unmount=async()=>{t.destroy(n),t.unmount(n),n.remove()},n}else o.template&&!s&&(r.innerHTML=o.template);return r.unmount=()=>{t.destroy(r),t.unmount(r),r.innerHTML=""},r}}async function D(r,t,e){let s=[async()=>await r.loaded(),async()=>{if(r.context.container=t(),typeof document<"u")return await r.rendered()},async()=>(await r.props(),r.params(),r.methods(),r.proxies(),await r.created()),async()=>{if(await r.nodes(),typeof document<"u")return await r.mounted()}];for await(let o of s){let n=await o();if(r.context.phase++,r.context.abortSignal?.aborted||n){e&&e({phase:r.context.phase,data:n,abortSignal:r.context.abortSignal});return}}return r.context.container}async function M(r,t,e={},s={}){let{signal:o,aborted:n,params:i,methods:a,proxies:p,sections:c,section:m,ssr:E}=e,u=t.nodepath||"root";o&&!(o instanceof AbortSignal)&&h(u,217),n&&typeof n!="function"&&h(u,218);let l=await b(r,o);if(!l)return h(u,216);let A=new V(U(l),s,o,H);return A.context.options.inputs={params:i,methods:a,proxies:p,sections:c},await D(A,()=>k(t,A,m,E),n)}async function z(r,t,e,s){if(!r)return h("root",216);e&&!(e instanceof AbortSignal)&&h("root",217),s&&typeof s!="function"&&h("root",218);let o=new $(r,{},e,g);return await D(o,()=>{t.innerHTML=r.template,o.context.container=t},s),{destroy(){delete t.reactivity,delete t.method,t.innerHTML=""}}}window.lesta={mountComponent:M,mountWidget:z,replicate:f,deliver:v,deleteReactive:O,cleanHTML:j,loadModule:b,queue:L};})();
