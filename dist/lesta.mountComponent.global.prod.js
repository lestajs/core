(()=>{var Z=Object.defineProperty;var tt=(e,t)=>{for(var r in t)Z(e,r,{get:t[r],enumerable:!0})};function u(e){return e?typeof e=="object"?JSON.parse(JSON.stringify(e)):e:e??null}function E(e,t="",r){let n=t.split("."),o;try{for(o=0;o<n.length-1;o++)e=e[n[o]];return r!==void 0&&(e[n[o]]=r),e[n[o]]}catch{}}async function b(e,t){if(typeof e=="function"){let r=e();return!(r instanceof Promise)||t?.aborted?void 0:(await(async()=>t?t.aborted?void 0:await Promise.race([r,new Promise(s=>t.addEventListener("abort",()=>s()))]):await r)())?.default}return e}function O(e,t){for(let[r,n]of e)if(Array.isArray(n)){let o=n.indexOf(t);o!==-1&&(n.length===1?e.delete(r):n.splice(o,1))}else n===t&&e.delete(r)}function v(e){function t(c){let a=document.createElement("capsule");return a.innerHTML=c,a}function r(c){let a=c.querySelectorAll("script");for(let p of a)p.remove()}function n(c,a){let p=a.replace(/\s+/g,"").toLowerCase();if(["src","href","xlink:href"].includes(c)&&(p.includes("javascript:")||p.includes("data:text/html"))||c.startsWith("on"))return!0}function o(c){let a=c.attributes;for(let{name:p,value:h}of a)n(p,h)&&c.removeAttribute(p)}function s(c){let a=c.children;for(let p of a)o(p),s(p)}let i=t(e);return r(i),s(i),i.childNodes}var $=()=>{let e=[],t=!1,r=()=>e.length,n=()=>e.length===0,o=i=>{e.push(i),t||(t=!0,s())},s=async()=>{let i=e.at(0);i?(await i(),e.shift(),s()):t=!1};return{add:o,isEmpty:n,size:r}};var l=(e,t,r="")=>{};var A={};tt(A,{_attr:()=>U,_class:()=>W,_evalHTML:()=>I,_event:()=>z,_html:()=>q,_text:()=>k});var q={update:(e,t)=>{t!==void 0&&(e.innerHTML="",t&&e.append(...v(t)))}};var I={update:(e,t)=>t!==void 0?e.innerHTML=t:""};var W={update:(e,t,r)=>t?e.classList.add(r):e.classList.remove(r)};var k={update:(e,t)=>{t!==void 0&&(e.textContent=t!==Object(t)?t:JSON.stringify(t))}};var U={update:(e,t,r)=>{typeof t=="boolean"?t?e.setAttribute(r,""):e.removeAttribute(r):e.setAttribute(r,t)}};var z={create:(e,t)=>{for(let r in t)e.addEventListener(r,t[r])},destroy:(e,t)=>{for(let r in t)e.removeEventListener(r,t[r])}};var F={refs:[],collect:!1,define(e){return e&&this.refs.every(t=>t.startsWith(this.refs.at(0)))?this.refs.at(-1):[...this.refs]},clear(){this.collect=!1,this.refs.length=0}};var N=class{constructor(t,r,n={},o){this.component=t,this.app=n,this.impress=F,this.proxiesData={},this.context={app:n,container:r,options:t,phase:0,abortSignal:o,node:{},param:{},method:{},proxy:{},source:t.sources||{},directives:{...A,...n.directives,...t.directives}}}async loaded(t){return await this.component.loaded?.bind(this.context)(t)}async rendered(){return typeof this.component!="object"?l(this.context.container.nodepath,211):await this.component.rendered?.bind(this.context)()}async created(){return await this.component.created?.bind(this.context)()}methods(){if(this.component.methods){this.component.outwards?.methods?.length&&(this.context.container.method={});for(let[t,r]of Object.entries(this.component.methods)){if(this.context.method.hasOwnProperty(t))return l(this.context.container.nodepath,212,t);this.context.method[t]=r.bind(this.context),this.component.outwards?.methods?.includes(t)&&(this.context.container.method[t]=(...n)=>{let o=r.bind(this.context)(u(...n));return o instanceof Promise?o.then(s=>u(s)):u(o)})}}Object.preventExtensions(this.context.method)}params(){if(this.component.params){this.component.outwards?.params?.length&&(this.context.container.param={});for(let t in this.component.params){if(this.context.param.hasOwnProperty(t))return l(this.context.container.nodepath,213,t);this.component.outwards?.params?.includes(t)&&(this.context.container.param[t]=this.component.params[t])}Object.assign(this.context.param,this.component.params)}Object.preventExtensions(this.context.param)}proxies(){if(this.component.proxies)for(let t in this.component.proxies){if(t in this.proxiesData)return l(this.context.container.nodepath,214,t);this.proxiesData[t]=this.component.proxies[t]}this.context.proxy=this.getProxy(),Object.preventExtensions(this.context.proxy)}};function j(e,t,r=""){if(!(e&&(e.constructor.name==="Object"||e.constructor.name==="Array")))return e;let n={getPrototypeOf(o){return{target:o,instance:"Proxy"}},get(o,s,i){return t.get?.(o,s,`${r}${s}`),Reflect.get(o,s,i)},set(o,s,i,c){let a=!1;return t.beforeSet(i,`${r}${s}`,h=>{i=h,a=!0})||!(Reflect.get(o,s,c)!==i||s==="length"||a)||(i=j(i,t,`${r}${s}.`),Reflect.set(o,s,i,c),t.set(o,i,`${r}${s}`)),!0},deleteProperty(o,s){return Reflect.deleteProperty(o,s)},defineProperty(o,s,i){return Reflect.defineProperty(o,s,i)}};e=u(e);for(let o in e)e.hasOwnProperty(o)&&(e[o]=j(e[o],t,`${r}${o}.`));return new Proxy(e,n)}function g(e,t,r){if(!e)return;let n=(o,s)=>{let i=Math.min(o.length,s.length);return o.slice(0,i)===s.slice(0,i)};for(let[o,s]of e)Array.isArray(s)?s.includes(t)&&o(r):n(t,s)&&o(r,t.length>s.length?t.replace(s+".",""):void 0)}var f=(e,t,r="")=>{};var L=class extends N{constructor(t,r,n,o,s){super(t,r,n,o),this.factory=s}async props(){}async mounted(){await this.component.mounted?.bind(this.context)()}actives(t,r){g(t.reactivity?.node,r)}getProxy(){return j(this.proxiesData,{beforeSet:(t,r,n)=>{if(this.component.setters?.[r]){let o=this.component.setters[r].bind(this.context)(t);if(o===void 0)return!0;n(o)}},set:(t,r,n)=>{for(let o in this.context.node)this.actives(this.context.node[o],n,r);this.component.handlers?.[n]?.bind(this.context)(r)},get:(t,r,n)=>{this.impress.collect&&!this.impress.refs.includes(n)&&t.hasOwnProperty(r)&&this.impress.refs.push(n)}})}async nodes(){if(this.component.nodes){let t=this.component.nodes.bind(this.context)(),r=this.context.container,n=r.target;for(let o in t){let s=t[o]?.selector||this.context.app.selector||`.${o}`,i=typeof s=="function"?s(o):s,c=n.querySelector(i)||n.classList.contains(o)&&n,a=r.nodepath+"."+o;if(c){if(r.spot&&Object.values(r.spot).includes(c)){f(a,107,o);continue}Object.assign(this.context.node,{[o]:{target:c,nodepath:a,nodename:o,directives:{}}})}else f(a,105)}Object.preventExtensions(this.context.node);for await(let[o,s]of Object.entries(this.context.node))await this.factory(t[o],this.context,s,this.impress,this.app).controller()}}};var x=(e,t,r,n,o="")=>{};var H=class{constructor(t,r,n){this.props=t,this.context=r,this.container=r.container,this.app=n}async setup(t){if(this.props.proxies&&Object.keys(this.props.proxies).length&&!t?.proxies)return x(this.container.nodepath,306);if(this.container.proxy||(this.container.proxy={}),t)return await this.params(t.params),await this.methods(t.methods),await this.proxies(t.proxies)}validation(t,r,n,o,s){let i=this.container.nodepath,c=(m,d)=>m&&d&&!(typeof m===d||d==="array"&&Array.isArray(m))&&x(i,s,n,304,d),a=(m,d)=>m&&Array.isArray(d)&&!d.includes(m)&&x(i,s,n,302,m),p=(m,d)=>m??(d.required&&x(i,s,n,303))??d.default??m,h=(m,d)=>typeof d=="string"?c(m,d):(c(m,d.type),a(m,d.enum),p(m,d));return{string:()=>c(o,r),object:()=>{o=h(o,r),r.validate?.(o,h)},function:()=>r(o,h)}[typeof r]?.(),t[n]=o,h}async proxies(t){if(t){let r={},n=this.context;for(let o in t){let s=t[o],i=null;this.container.proxy[o]={getValue:()=>u(n.proxy[o]),setValue:(p,h)=>{h?(E(n.proxy[o],h,u(p)),s.validate?.(n.proxy[o],i)):this.validation(n.proxy,s,o,u(p),"proxies")},isIndependent:()=>this.props.proxies[o]?.hasOwnProperty("_independent")?this.props.proxies[o]._independent:!0};let c=null,{store:a}=s;if(this.props.proxies?.hasOwnProperty(o))c=this.props.proxies[o]?._value;else if(a){let p=await this.app.store?.init(a);if(!p)return x(this.container.nodepath,"proxies",o,307,a);c=p.proxies(o,this.container)}i=this.validation(r,s,o,u(c),"proxies")}return r}}async params(t){for(let r in t){let n=t[r],o=async()=>{let{store:s}=n,i=null;if(s){let c=await this.app.store?.init(s);if(!c)return x(this.container.nodepath,"params",r,307,s);i=c.params(r)}else i=this.props?.params[r];return n?.hole?i:u(i)};this.validation(this.context.param,n,r,await o(),"params"),n.readonly&&Object.defineProperty(this.context.param,r,{writable:!1})}}async methods(t){let r=(n,o)=>{this.context.method[o]=(...s)=>{if(s.length&&(s.length>1||typeof s.at(0)!="object"))return x(this.container.nodepath,"methods",o,301);let i=n({...u(s.at(0)),_params:this.context.container.param,_methods:this.context.container.method});return i instanceof Promise?i.then(c=>u(c)):u(i)}};for(let n in t){let o=t[n],{store:s}=o;if(s){let i=await this.app.store?.init(s);if(!i)return x(this.container.nodepath,"methods",n,307,s);let c=i.methods(n);if(!c)return x(this.container.nodepath,"methods",n,305,s);r(c,n)}else{let i=this.props.methods?.hasOwnProperty(n);if(o?.required&&!i)return x(this.container.nodepath,"methods",n,303);i&&r(this.props.methods[n],n)}}}},J={async init(e,t,r,n){return await new H(e,r,n).setup(t)}};var M=class extends L{constructor(...t){super(...t)}async props(t){this.proxiesData=await J.init(t,this.component.props,this.context,this.app)||{}}actives(t,r,n){let o=i=>{g(i.reactivity?.node,r),g(i.reactivity?.component,r,n)},s=i=>{for(let c in i.spot)o(i.spot[c]),s(i.spot[c])};o(t),t.children?t.children.forEach(i=>s(i)):s(t)}destroy(t){t.reactivity?.component?.clear(),delete t.proxy,delete t.method;for(let r in t.unstore)t.unstore[r]()}unmount(t){if(this.context.node)for(let r of Object.values(this.context.node)){if(r.directives)for(let n of Object.values(r.directives))n.destroy?.();if(r.reactivity?.node?.clear(),!r.unmount)return;for(let n in r.spot)r.spot[n].unmount?.();r.unmount()}this.component.unmounted?.bind(this.context)(),delete t.unmount}};function S(e){if(e.mixins?.length){let t=["directives","params","proxies","methods","handlers","setters","sources"],r=["params","proxies","methods"],n=["loaded","rendered","created","mounted","unmounted"],o={props:{},outwards:{params:[],methods:[]},spots:[]},s=(a,p,h)=>({...a[h],...p[h]}),i=(a,p)=>[...a,...p||[]],c=a=>{o.template=a.template||o.template,o.outwards.params=i(o.outwards.params,a.outwards?.params),o.outwards.methods=i(o.outwards.methods,a.outwards?.methods),o.spots=i(o.spots,a.spots),t.forEach(h=>{o[h]=s(o,a,h)}),n.forEach(h=>{let w=o[h];o[h]=async function(){return a[h]?.bind(this)()||w?.bind(this)()}}),r.forEach(h=>{o.props[h]=s(o.props,a.props||{},h)});let p=o.nodes;o.nodes=function(){return{...p?.bind(this)(),...a.nodes?.bind(this)()}}};return e.mixins.forEach(a=>{c(S(a))}),c(e),o}return e}var _={directives(e){let t=this.nodeElement;if(!e.startsWith("_"))return f(t.nodepath,102,e);let r=this.context.directives[e],n=this.nodeOptions[e],{create:o,update:s,destroy:i}=r;Object.assign(t.directives,{[e]:{create:()=>o?o.bind(r)(t.target,n):{},destroy:()=>i?i.bind(r)(t.target,n):{}}}),o&&t.directives[e].create();let c=(a,p,h)=>{let w=m=>s.bind(r)(t.target,m,p,h);typeof a=="function"?(this.impress.collect=!0,w(a(t.target)),this.reactiveNode(this.impress.define(),()=>w(a(t.target)))):w(a)};if(s)if(typeof n=="object")for(let a in n)c(n[a],a,n);else c(n)}};var C={listeners(e){typeof this.nodeOptions[e]=="function"&&(this.nodeElement.target[e]=t=>this.nodeOptions[e].bind(this.context)(t))},general(e){if(e==="innerHTML")return f(this.nodeElement.nodepath,106);if(typeof this.nodeOptions[e]=="function"){let t=()=>{let r=this.nodeOptions[e].bind(this.context)();this.nodeElement.target[e]!==null&&typeof this.nodeElement.target[e]=="object"?r!==null&&typeof r=="object"?Object.assign(this.nodeElement.target[e],r):f(this.nodeElement.nodepath,103,e):this.nodeElement.target[e]=r};this.impress.collect=!0,t(),this.reactiveNode(this.impress.define(),t)}else this.nodeElement.target[e]=this.nodeOptions[e]},native(e){e.startsWith("on")?this.listeners(e):this.general(e)}};var X={async iterative(e){if(typeof e.iterate!="function")return l(this.nodeElement.nodepath,205);if(this.name=null,this.nodeElement.children=[],this.nodeOptions.component=e,this.nodeElement.clear=()=>this.length.bind(this)(0),this.createIterate=async t=>{this.nodeElement.children[t]=this.nodeElement._current={parent:this.nodeElement,target:!0,nodepath:this.nodeElement.nodepath+"."+t,index:t,isIterable:!0},await this.create(this.proxiesIterate.bind(this),this.nodeElement.children[t],e)},this.impress.collect=!0,this.data=e.iterate(),this.data){if(!Array.isArray(this.data))return l(this.nodeElement.nodepath,206);this.name=this.impress.refs.at(-1),this.impress.clear(),this.nodeElement.isIterative=!0,Object.getPrototypeOf(this.data).instance==="Proxy"&&(this.reactiveComponent([this.name],n=>{if(this.data=e.iterate(),e.proxies){for(let[o,s]of Object.entries(e.proxies))if(typeof s=="function"&&s.name)for(let i=0;i<Math.min(this.nodeElement.target.children.length,n.length);i++)this.nodeElement.children[i]?.proxy?.[o]?.setValue(s(this.nodeElement.children[i]))}this.length(n.length)}),this.reactiveComponent([this.name+".length"],n=>this.length(n)));let t=async()=>{this.data=e.iterate(),await this.length(this.data.length)};this.induced(async n=>n?await t():this.nodeElement.clear())&&await t()}},proxiesIterate(e){let t=this.nodeElement._current,r=(n,o)=>{this.impress.refs.some(s=>s.includes(this.name))?this.reactiveComponent(this.impress.define(n),(s,i)=>{t.proxy&&(i?t.proxy[n]?.setValue(s,i):t.proxy[n]?.setValue(o(t)))}):this.nodeElement.created?this.impress.clear():this.reactiveComponent(this.impress.define(n),(s,i)=>{for(let c=0;c<this.nodeElement.target.children.length;c++){let a=this.nodeElement.children[c];i?a.proxy?.[n]?.setValue(s,i):a.proxy?.[n]?.setValue(o(a))}})};return this.reactivate(e,r,t)},async length(e){let t=this.nodeElement.children.length;e>t&&await this.add(e,t),e<t&&this.remove(e,t)},async add(e,t){for(;e>t;){if(await this.createIterate(t),!this.nodeElement.target.children[t])return;t++}},remove(e,t){for(;e<t;)t--,O(this.nodeElement.reactivity.component,this.name+"."+t),this.nodeElement.children[t].unmount?.(),this.nodeElement.children[t].target.remove(),this.nodeElement.children.splice(t,1)}};var Q={async basic(e){this.nodeOptions.component=e;let t=async()=>await this.create(this.proxies.bind(this),this.nodeElement,e);this.induced(async n=>n?await t():this.nodeElement.unmount?.())&&await t()},proxies(e){if(!e)return;let t=(r,n)=>this.reactiveComponent(this.impress.define(r),(o,s)=>{s?this.nodeElement.proxy?.[r]?.setValue(o,s):this.nodeElement.proxy?.[r]?.setValue(n(this.nodeElement))});return this.reactivate(e,t)}};var B={collect(e,t){return{params:this.params(e.params,t),methods:this.methods(e.methods)}},methods(e){let t={};if(e)for(let[r,n]of Object.entries(e))typeof n=="function"&&Object.assign(t,{[r]:n});return t},params(e,t){let r={};if(e)for(let[n,o]of Object.entries(e))Object.assign(r,{[n]:typeof o=="function"&&o.name?o(t):o});return r}};var G={async component(){if(this.nodeElement.reactivity.component=new Map,this.nodeElement.isIterable)return l(this.nodeElement.nodepath,208);this.nodeElement.mount=async e=>{this.nodeElement.unmount?.(),this.nodeElement.created=!1,e.iterate?await this.iterative(e):await this.basic(e)},this.nodeOptions.component.async?this.nodeElement.mount(this.nodeOptions.component):await this.nodeElement.mount(this.nodeOptions.component)},induced(e){if(this.nodeOptions.component.hasOwnProperty("induce")){this.nodeElement.induce=e;let t=this.nodeOptions.component.induce;if(!t)return;if(typeof t=="function"){this.impress.collect=!0;let r=t();if(this.reactiveNode(this.impress.define(),async()=>await this.nodeElement.induce(t())),!r)return}}return!0},reactiveComponent(e,t){return this.reactive(e,t,this.nodeElement.reactivity.component)},reactivate(e,t){let r={};if(e)for(let[n,o]of Object.entries(e))if(typeof o=="function"&&o.name){this.impress.collect=!0;let s=a=>o(a),i=o(this.nodeElement._current||this.nodeElement),c=t(n,s);Object.assign(r,{[n]:{_value:i,_independent:!c}})}else Object.assign(r,{[n]:{_value:o,_independent:!0}});return r},async create(e,t,r){let{src:n,spots:o,aborted:s,completed:i,ssr:c}=r;if(n&&(await P(n,t,{aborted:s,completed:i,ssr:c,...B.collect(r,t),proxies:e(r.proxies)||{}},this.app),this.nodeElement.created=!0,!!o))for await(let[a,p]of Object.entries(o)){if(!t.spot?.hasOwnProperty(a)){l(t.nodepath,202,a);continue}let h=t.spot[a];Object.assign(h,{parent:t,nodepath:t.nodepath+"."+a,nodename:a,isSpot:!0}),await R(p,this.context,h,this.impress,this.app).controller()}}};var y=class{constructor(t,r,n,o,s){this.app=s,this.nodeOptions=t,this.context=r,this.impress=o,this.nodeElement=n,this.nodeElement.reactivity={node:new Map}}reactive(t,r,n){return t?.length&&n.set(r,t),this.impress.clear(),t}reactiveNode(t,r){this.reactive(t,r,this.nodeElement.reactivity.node)}async controller(){for(let t in this.nodeOptions)t in this.nodeElement.target?this.native(t):t in this.context.directives?this.directives(t):t==="component"?await this.component?.():t==="selector"?this.nodeElement.isSpot&&f(this.nodeElement.nodepath,108):f(this.nodeElement.nodepath,104,t)}};function R(...e){return Object.assign(y.prototype,C,_,X,Q,G),new y(...e)}function V(e,t,r){let n={...t.context.options};if(!n.template)return l(e.nodepath,209);let o=i=>typeof i=="function"?i.bind(t.context)():i,s=i=>{n.spots?.length&&(i.spot={}),n.spots?.forEach(c=>Object.assign(i.spot,{[c]:{target:i.target.querySelector(`[spot="${c}"]`)}}))};if(e.isIterable){let i=e.parent;i.children.length===1&&i.target.childNodes.length&&(i.target.innerHTML=""),i.target.insertAdjacentHTML("beforeEnd",o(n.template)),e.target=i.target.children[e.index],s(e),i.unmount||(i.unmount=()=>{t.destroy(i),i.clear(),delete i.unmount}),e.unmount=()=>{t.destroy(e),t.unmount(e),r.abort()}}else e.target.innerHTML=o(n.template),s(e),e.unmount=()=>{t.destroy(e),t.unmount(e),e.target.innerHTML="",r.abort()}}async function T(e,t,r){let n=[async()=>await e.loaded(),async()=>(await e.props(r),e.params(),e.methods(),e.proxies(),await e.created()),async()=>{if(t(),typeof document<"u")return await e.rendered()},async()=>{if(await e.nodes(),typeof document<"u")return await e.mounted()}],o=s=>({container:e.context.container,phase:e.context.phase,data:s});for await(let s of n){let i=await s();if(e.context.phase++,e.context.abortSignal?.aborted||i){r.aborted?.(o(u(i)));return}}return r.completed?.(o(null)),e.context.container}async function P(e,t,r,n={}){let o=new AbortController,s=o.signal,i=await b(e,s);if(!i)return l(t.nodepath,216);let c=new M(S(i),t,n,s,R);return await T(c,()=>!r.ssr&&V(t,c,o),r)}function Y(...e){return Object.assign(y.prototype,C,_),new y(...e)}async function D({options:e,target:t,name:r="root",aborted:n,completed:o}){if(!e)return l(r,216);if(!t)return l(r,217);let s=new AbortController,i=s.signal,c={target:t,nodepath:r,unmount(){delete a.context.container,t.innerHTML="",s.abort()}},a=new L(e,c,{},i,Y);return await T(a,()=>{t.innerHTML=e.template,a.context.container=c},{aborted:n,completed:o})}window.lesta={mountComponent:P,mountWidget:D,replicate:u,deliver:E,deleteReactive:O,cleanHTML:v,loadModule:b,queue:$};})();
