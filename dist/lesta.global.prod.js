(()=>{var Y=Object.defineProperty;var Z=(e,t)=>{for(var r in t)Y(e,r,{get:t[r],enumerable:!0})};function m(e){return e?typeof e=="object"?JSON.parse(JSON.stringify(e)):e:e??null}function O(e,t=[],r){let n=Array.isArray(t)?t:t.split("."),o;try{for(o=0;o<n.length-1;o++)e=e[n[o]];return r!==void 0&&(e[n[o]]=r),e[n[o]]}catch{}}async function w(e,t,r){return new Promise((n,o)=>{let s=()=>{o(),r?.(),t.removeEventListener("abort",s)};t.addEventListener("abort",s),t.aborted&&s(),e.then(n).catch(o)})}async function g(e,t,r){if(typeof e=="function"){let n=e();return n instanceof Promise?{...(await w(n,t,r))?.default}:n}return{...e}}function v(e,t){for(let[r,n]of e)if(Array.isArray(n)){let o=n.indexOf(t);o!==-1&&(n.length===1?e.delete(r):n.splice(o,1))}else n===t&&e.delete(r)}var u=(e,t,r="")=>{};var T={};Z(T,{_attr:()=>U,_class:()=>k,_event:()=>W,_text:()=>I});var k={update:(e,t,r)=>t?e.classList.add(r):e.classList.remove(r)};var I={update:(e,t)=>{t!==void 0&&(e.textContent=t!==Object(t)?t:JSON.stringify(t))}};var U={update:(e,t,r)=>{typeof t=="boolean"?t?e.setAttribute(r,""):e.removeAttribute(r):e.setAttribute(r,t)}};var W={create:(e,t)=>{for(let r in t)e.addEventListener(r,t[r])},destroy:(e,t)=>{for(let r in t)e.removeEventListener(r,t[r])}};var F={refs:[],collect:!1,define(e){return e&&this.refs.every(t=>t.startsWith(this.refs.at(0)))?this.refs.at(-1):[...this.refs]},clear(){this.collect=!1,this.refs.length=0}};var $=class{constructor(t,r,n={},o){this.component=t,this.app=n,this.impress=F,this.proxiesData={},this.context={app:n,container:r,options:t,phase:0,abort:()=>o.abort(),abortSignal:o.signal,node:{},param:{},method:{},proxy:{},source:t.sources||{},directives:{...T,...n.directives,...t.directives}}}async loaded(t){return await this.component.loaded?.bind(this.context)(t)}async rendered(){return typeof this.component!="object"?u(this.context.container.nodepath,211):await this.component.rendered?.bind(this.context)()}async created(){return await this.component.created?.bind(this.context)()}methods(){if(this.component.methods){this.context.container.action={};for(let[t,r]of Object.entries(this.component.methods)){if(this.context.method.hasOwnProperty(t))return u(this.context.container.nodepath,212,t);this.context.method[t]=r.bind(this.context),this.component.actions?.includes(t)&&(this.context.container.action[t]=(...n)=>{let o=r.bind(this.context)(m(...n));return o instanceof Promise?o.then(s=>m(s)):m(o)})}}Object.preventExtensions(this.context.container.action),Object.preventExtensions(this.context.method)}params(){if(this.component.params){for(let t in this.component.params)if(this.context.param.hasOwnProperty(t))return u(this.context.container.nodepath,213,t);Object.assign(this.context.param,this.component.params)}Object.preventExtensions(this.context.param)}proxies(){if(this.component.proxies)for(let t in this.component.proxies){if(t in this.proxiesData)return u(this.context.container.nodepath,214,t);this.proxiesData[t]=this.component.proxies[t]}this.context.proxy=this.getProxy(),Object.preventExtensions(this.context.proxy)}};function j(e,t,r=""){if(!(e&&(e.constructor.name==="Object"||e.constructor.name==="Array")))return e;let n={getPrototypeOf(o){return{target:o,instance:"Proxy"}},get(o,s,i){return t.get?.(o,s,`${r}${s}`),Reflect.get(o,s,i)},set(o,s,i,a){return t.beforeSet(i,`${r}${s}`,d=>{i=d})||!(Reflect.get(o,s,a)!==i||s==="length")||(i=j(i,t,`${r}${s}.`),Reflect.set(o,s,i,a),t.set(o,i,`${r}${s}`)),!0},deleteProperty(o,s){return Reflect.deleteProperty(o,s)},defineProperty(o,s,i){return Reflect.defineProperty(o,s,i)}};e=m(e);for(let o in e)e.hasOwnProperty(o)&&(e[o]=j(e[o],t,`${r}${o}.`));return new Proxy(e,n)}function E(e,t,r){if(!e)return;let n=(o,s)=>{let i=Math.min(o.length,s.length);return o.slice(0,i)===s.slice(0,i)};for(let[o,s]of e)Array.isArray(s)?s.includes(t)&&o(r):n(t,s)&&o(r,t.length>s.length?t.replace(s+".",""):void 0)}var x=(e,t,r="")=>{};var P=class extends ${constructor(t,r,n,o,s){super(t,r,n,o),this.factory=s}async props(){}async mounted(){await this.component.mounted?.bind(this.context)()}actives(t,r){E(t.reactivity?.node,r)}getProxy(){return j(this.proxiesData,{beforeSet:(t,r,n)=>{if(this.component.setters?.[r]){let o=this.component.setters[r].bind(this.context)(t);if(o===void 0)return!0;n(o)}},set:(t,r,n)=>{for(let o in this.context.node)this.actives(this.context.node[o],n,r);this.component.handlers?.[n]?.bind(this.context)(r)},get:(t,r,n)=>{this.impress.collect&&!this.impress.refs.includes(n)&&t.hasOwnProperty(r)&&this.impress.refs.push(n)}})}async nodes(){if(this.component.nodes){let t=this.component.nodes.bind(this.context)(),r=this.context.container,n=r.target;for(let o in t){let s=t[o].selector||this.context.app.selector||`.${o}`,i=typeof s=="function"?s(o):s,a=n.querySelector(i)||n.matches(i)&&n,p=r.nodepath+"."+o;if(a){if(a._engaged)return x(p,106,o);if(a._engaged=!0,r.spot&&Object.values(r.spot).includes(a)){x(p,107,o);continue}Object.assign(this.context.node,{[o]:{target:a,nodepath:p,nodename:o,directives:{}}})}else x(p,105)}Object.preventExtensions(this.context.node);for await(let[o,s]of Object.entries(this.context.node))await this.factory(t[o],this.context,s,this.impress,this.app).controller()}}};var y=(e,t,r,n,o="")=>{};var V=class{constructor(t,r,n){this.props=t,this.context=r,this.container=r.container,this.app=n}async setup(t){if(this.props.proxies&&Object.keys(this.props.proxies).length&&!t?.proxies)return y(this.container.nodepath,306);if(this.container.proxy||(this.container.proxy={}),t)return await this.params(t.params),await this.methods(t.methods),await this.proxies(t.proxies)}validation(t,r,n,o,s){let i=this.container.nodepath,a=(c,l)=>c&&l&&!(typeof c===l||l==="array"&&Array.isArray(c))&&y(i,s,n,304,l),p=(c,l)=>c&&Array.isArray(l)&&!l.includes(c)&&y(i,s,n,302,c),d=(c,l)=>c??(l.required&&y(i,s,n,303))??l.default??c,f=(c,l)=>typeof l=="string"?a(c,l):(a(c,l.type),p(c,l.enum),d(c,l));return{string:()=>a(o,r),object:()=>{o=f(o,r),r.validate?.(o,f)},function:()=>r(o,f)}[typeof r]?.(),t[n]=o,f}async proxies(t){if(t){let r={},n=this.context;for(let o in t){let s=t[o],i=null;this.container.proxy[o]={getValue:()=>m(n.proxy[o]),setValue:(d,f)=>{f?(O(n.proxy[o],f,m(d)),s.validate?.(n.proxy[o],i)):this.validation(n.proxy,s,o,m(d),"proxies")},isIndependent:()=>this.props.proxies[o]?.hasOwnProperty("_independent")?this.props.proxies[o]._independent:!0};let a=null,{store:p}=s;if(this.props.proxies?.hasOwnProperty(o))a=this.props.proxies[o]?._value;else if(p){let d=await this.app.store?.init(p);if(!d)return y(this.container.nodepath,"proxies",o,307,p);a=d.proxies(o,this.container)}i=this.validation(r,s,o,m(a),"proxies")}return r}}async params(t){for(let r in t){let n=t[r],o=async()=>{let{store:s}=n,i=null;if(s){let a=await this.app.store?.init(s);if(!a)return y(this.container.nodepath,"params",r,307,s);i=a.params(r)}else i=this.props?.params[r];return n?.hole?i:m(i)};this.validation(this.context.param,n,r,await o(),"params"),n.readonly&&Object.defineProperty(this.context.param,r,{writable:!1})}}async methods(t){let r=(n,o)=>{this.context.method[o]=(...s)=>{if(s.length&&(s.length>1||typeof s.at(0)!="object"))return y(this.container.nodepath,"methods",o,301);let i=n({...m(s.at(0)),_params:this.context.container.param,_methods:this.context.container.method});return i instanceof Promise?i.then(a=>m(a)):m(i)}};for(let n in t){let o=t[n],{store:s}=o;if(s){let i=await this.app.store?.init(s);if(!i)return y(this.container.nodepath,"methods",n,307,s);let a=i.methods(n);if(!a)return y(this.container.nodepath,"methods",n,305,s);r(a,n)}else{let i=this.props.methods?.hasOwnProperty(n);if(o?.required&&!i)return y(this.container.nodepath,"methods",n,303);i&&r(this.props.methods[n],n)}}}},z={init(e,t,r,n){return new V(e,r,n).setup(t)}};var L=class extends P{constructor(...t){super(...t)}async props(t){this.proxiesData=await z.init(t,this.component.props,this.context,this.app)||{}}actives(t,r,n){let o=i=>{E(i.reactivity?.node,r),E(i.reactivity?.component,r,n)},s=i=>{for(let a in i.spot)o(i.spot[a]),s(i.spot[a])};o(t),t.children?t.children.forEach(i=>s(i)):s(t)}destroy(t){t.reactivity?.component?.clear(),delete t.proxy,delete t.method;for(let r in t.unstore)t.unstore[r]()}unmount(t){if(this.context.node)for(let r of Object.values(this.context.node)){if(r.directives)for(let n of Object.values(r.directives))n.destroy?.();if(r.reactivity?.node?.clear(),!r.unmount)return;for(let n in r.spot)r.spot[n].unmount?.();r.unmount()}this.component.unmounted?.bind(this.context)(),delete t.unmount}};function S(e){if(!e.mixins?.length)return e;let t=["directives","params","proxies","methods","handlers","setters","sources"],r=["params","proxies","methods"],n=["loaded","rendered","created","mounted","unmounted"],o={props:{},actions:[],spots:[]},s=[],i={},a=(h,c,l)=>({...h[l],...c[l]}),p=(h,c)=>[...h,...c||[]],d=(h={},c={})=>{for(let l in c)h[l]={...h[l]||{},...c[l]};return h},f=h=>{o.template=h.template||o.template,o.actions=p(o.actions,h.actions),o.spots=p(o.spots,h.spots),t.forEach(c=>{o[c]=a(o,h,c)}),n.forEach(c=>{h[c]&&(o[c]=h[c])}),r.forEach(c=>{o.props[c]=a(o.props,h.props||{},c)}),h.nodes&&s.push(h.nodes)};return o.nodes=function(){return s.forEach(h=>{d(i,h.bind(this)())}),i},e.mixins.forEach(h=>{f(S(h))}),f(e),o}var C={directives(e){let t=this.nodeElement;if(!e.startsWith("_"))return x(t.nodepath,102,e);let r=this.context.directives[e],n=this.nodeOptions[e],{create:o,update:s,destroy:i}=r;Object.assign(t.directives,{[e]:{create:()=>o?o.bind(r)(t.target,n):{},destroy:()=>i?i.bind(r)(t.target,n):{}}}),o&&t.directives[e].create();let a=(p,d,f)=>{let h=c=>s.bind(r)(t.target,c,d,f);typeof p=="function"?(this.impress.collect=!0,h(p(t.target)),this.reactiveNode(this.impress.define(),()=>h(p(t.target)))):h(p)};if(s)if(typeof n=="object")for(let p in n)a(n[p],p,n);else a(n)}};var _={listeners(e){typeof this.nodeOptions[e]=="function"&&(this.nodeElement.target[e]=t=>this.nodeOptions[e].bind(this.context)(t))},general(e){let t=r=>{this.nodeElement.target[e]!==null&&typeof this.nodeElement.target[e]=="object"?r!==null&&typeof r=="object"?Object.assign(this.nodeElement.target[e],r):x(this.nodeElement.nodepath,103,e):this.nodeElement.target[e]=r};if(typeof this.nodeOptions[e]=="function"){let r=()=>t(this.nodeOptions[e].bind(this.context)());this.impress.collect=!0,r(),this.reactiveNode(this.impress.define(),r)}else t(this.nodeOptions[e])},native(e){e.startsWith("on")?this.listeners(e):this.general(e)}};var J={async iterative(e){if(typeof e.iterate!="function")return u(this.nodeElement.nodepath,205);if(this.nodeElement.replaced)return u(this.nodeElement.nodepath,204);if(this.name=null,this.repeat=0,this.nodeElement.children=[],this.nodeOptions.component=e,this.nodeElement.clear=()=>this.length.bind(this)(0),this.createIterate=async t=>{this.nodeElement.children[t]=this.nodeElement._current={parent:this.nodeElement,target:!0,nodepath:this.nodeElement.nodepath+"."+t,index:t,iterated:!0},await this.create(this.proxiesIterate.bind(this),this.nodeElement._current,e)},this.impress.collect=!0,this.data=e.iterate(),this.data){if(!Array.isArray(this.data))return u(this.nodeElement.nodepath,205);this.name=this.impress.refs.at(-1),this.impress.clear(),Object.getPrototypeOf(this.data).instance==="Proxy"&&(this.reactiveComponent([this.name],n=>this.length(n.length)),this.reactiveComponent([this.name+".length"],n=>this.length(n)));let t=async()=>{this.data=e.iterate(),await this.length(this.data.length)};this.induced(async n=>n?await t():this.nodeElement.clear())&&await t()}},proxiesIterate(e){let t=this.nodeElement._current,r=(n,o)=>{this.impress.refs.some(s=>s.includes(this.name))?this.reactiveComponent(this.impress.define(n),(s,i)=>{let a=(...p)=>t.proxy?.[n]?.setValue(...p);i?a(s,i):a(o(t))}):this.nodeElement.created?this.impress.clear():this.reactiveComponent(this.impress.define(n),(s,i)=>{let a=this.nodeElement.children,p=d=>{let f=a[d],h=(...c)=>f.proxy?.[n]?.setValue(...c);i?h(s,i):h(o(f))};this.portions(a.length,0,p),this.repeat++})};return this.reactivate(e,r,t)},async portions(e,t,r){if(!e)return;let{portion:n}=this.nodeOptions.component,o=null,s=!1;if(t<e-n){let i=()=>{if(this.repeat>1)return this.repeat--;this.portions(e,t,r)};setTimeout(()=>s?i():new Promise(a=>o=a).then(a=>i()))}do if(await r(t),t++,o&&(n=1),t>=e){this.repeat=0;break}while(t%n!==0);s=!0,o?.()},async length(e){this.repeat++;let t=this.nodeElement.children.length;if(e>t&&await this.portions(e,t,async r=>await this.createIterate(r)),e<t)for(;e<t;){t--;let r=this.nodeElement.children;v(this.nodeElement.reactivity.component,this.name+"."+t),r[t].unmount?.(),r[t].target.remove?.(),r.splice(t,1)}}};var B={async basic(e){this.nodeOptions.component=e;let t=()=>this.create(this.proxies.bind(this),this.nodeElement,e);this.induced(async n=>n?await t():this.nodeElement.unmount?.())&&await t()},proxies(e){if(!e)return;let t=(r,n)=>this.reactiveComponent(this.impress.define(r),(o,s)=>{let i=(...a)=>this.nodeElement.proxy?.[r]?.setValue(...a);s?i(o,s):i(n(this.nodeElement))});return this.reactivate(e,t)}};var G={collect(e,t){return{params:this.params(e.params,t),methods:this.methods(e.methods)}},methods(e){let t={};if(e)for(let[r,n]of Object.entries(e))typeof n=="function"&&Object.assign(t,{[r]:n});return t},params(e,t){let r={};if(e)for(let[n,o]of Object.entries(e))Object.assign(r,{[n]:typeof o=="function"&&o.name?o(t):o});return r}};var K={async component(){if(this.nodeElement.reactivity.component=new Map,this.nodeElement.iterated)return u(this.nodeElement.nodepath,208);this.nodeElement.mount=t=>(this.nodeElement.unmount?.(),this.nodeElement.created=!1,t.iterate?this.iterative(t):this.basic(t));let e=()=>this.nodeElement.mount(this.nodeOptions.component);this.nodeOptions.component.async?e():await e()},induced(e){if(this.nodeOptions.component.hasOwnProperty("induce")){this.nodeElement.induce=e;let t=this.nodeOptions.component.induce;if(!t)return;if(typeof t=="function"){this.impress.collect=!0;let r=t();if(this.reactiveNode(this.impress.define(),async()=>await this.nodeElement.induce(t())),!r)return}}return!0},reactiveComponent(e,t){return this.reactive(e,t,this.nodeElement.reactivity.component)},reactivate(e,t){let r={};if(e)for(let[n,o]of Object.entries(e))if(typeof o=="function"&&o.name){this.impress.collect=!0;let s=p=>o(p),i=o(this.nodeElement._current||this.nodeElement),a=t(n,s);Object.assign(r,{[n]:{_value:i,_independent:!a}})}else Object.assign(r,{[n]:{_value:o,_independent:!0}});return r},async create(e,t,r){let{src:n,spots:o,aborted:s,completed:i}=r;if(n&&(await A(n,t,{aborted:s,completed:i,...G.collect(r,t),proxies:e(r.proxies)||{}},this.app),this.nodeElement.created=!0,!!o))for await(let[a,p]of Object.entries(o)){if(!t.spot?.hasOwnProperty(a)){u(t.nodepath,202,a);continue}let d=t.spot[a];Object.assign(d,{parent:t,nodepath:t.nodepath+"."+a,nodename:a,spoted:!0}),await R(p,this.context,d,this.impress,this.app).controller()}}};var b=class{constructor(t,r,n,o,s){this.app=s,this.nodeOptions=t,this.context=r,this.impress=o,this.nodeElement=n,this.nodeElement.reactivity={node:new Map}}reactive(t,r,n){return t?.length&&n.set(r,t),this.impress.clear(),t}reactiveNode(t,r){this.reactive(t,r,this.nodeElement.reactivity.node)}controller(){let t=this.nodeElement.nodepath,r=this.nodeElement.target.tagName==="TEMPLATE";this.nodeElement.replaced=r;for(let n in this.nodeOptions){if(r&&!["selector","component"].includes(n))return x(t,108,n);if(n in this.nodeElement.target)this.native(n);else if(n in this.context.directives)this.directives(n);else{if(n==="component")return this.component?.();if(n!=="selector")return x(t,104,n)}}}};function R(...e){return Object.assign(b.prototype,_,C,J,B,K),new b(...e)}function N(e,t){let r=typeof e=="function"?e.bind(t)():e,n=document.createElement("div");return n.innerHTML=r.trim(),n.childNodes}function D(e,t){let r={...t.context.options},n=s=>{if(!s)return u(e.nodepath,210);let i=N(s,t.context);return i.length>1?u(e.nodepath,210):i},o=s=>{r.spots?.length&&(s.spot={}),r.spots?.forEach(i=>Object.assign(s.spot,{[i]:{target:s.target.querySelector(`[spot="${i}"]`)}}))};if(e.iterated){let s=e.parent;s.children.length===1&&s.target.childNodes.length&&(s.target.innerHTML="");let i=n(r.template);s.target.append(...i),e.target=s.target.lastChild,o(e),s.unmount||(s.unmount=()=>{t.destroy(s),s.clear()}),e.unmount=()=>{t.destroy(e),t.unmount(e),t.context.abort()}}else{if(e.replaced){let s=n(r.template),i=e.target;e.target.before(...s),e.target=i.previousSibling,i.remove()}else{if(!r.template)return;let s=N(r.template,t.context);e.target.innerHTML="",e.target.append(...s)}o(e),e.unmount=()=>{t.destroy(e),t.unmount(e),e.target.innerHTML="",t.context.abort()}}}async function M(e,t,r,n,o){let s=[async()=>await e.loaded(r),async()=>{await e.props(r),e.params(),e.methods(),e.proxies(),await e.created()},async()=>{t(),await e.rendered()},async()=>{await e.nodes(),await e.mounted()}];try{for await(let i of s)await w(i(),e.context.abortSignal),e.context.phase++}catch{n()}return o?.(),e.context.container}async function A(e,t,r={},n={}){let o=new AbortController;t.unmount=()=>o.abort();let s=()=>r.aborted?.({phase:a?a.context.phase:0,reason:o.signal.reason}),i=await g(e,o.signal,s);if(!i)return u(t.nodepath,216);let a=new L(S(i),t,n,o,R);return await M(a,()=>D(t,a),r,s,r.completed)}function H(e={}){let t={};return e.mount=async({options:r,target:n,name:o="root"},s)=>(Object.assign(t,{target:n,nodepath:o}),await A(r,{target:n,nodepath:o},s,e)),e.unmount=()=>t.unmount?.(),Object.preventExtensions(e),e}function X(...e){return Object.assign(b.prototype,_,C),new b(...e)}async function q({options:e,target:t,name:r="root"},n={}){if(!e)return u(r,216);if(!t)return u(r,217);let o={...e},s=new AbortController,i={target:t,nodepath:r,unmount(){s.abort(),t.innerHTML="",a.component.unmounted?.bind(a.context)(),delete i.unmount}},a=new P(o,i,n,s,X);return await M(a,()=>{a.context.container=i,o.template&&t.append(...N(o.template,a.context))},{},()=>n.aborted?.({phase:a.context.phase,reason:s.signal.reason}),n.completed)}window.lesta={createApp:H,mountWidget:q,replicate:m,deliver:O,deleteReactive:v,loadModule:g,revocablePromise:w};})();
