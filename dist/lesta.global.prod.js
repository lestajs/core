(()=>{var et=Object.defineProperty;var rt=(e,t)=>{for(var r in t)et(e,r,{get:t[r],enumerable:!0})};function m(e){return e?typeof e=="object"?JSON.parse(JSON.stringify(e)):e:e??null}function j(e,t=[],r){let n=Array.isArray(t)?t:t.split("."),o;try{for(o=0;o<n.length-1;o++)e=e[n[o]];return r!==void 0&&(e[n[o]]=r),e[n[o]]}catch{}}async function g(e,t,r){return new Promise((n,o)=>{let s=()=>{o(),r?.(),t.removeEventListener("abort",s)};t.addEventListener("abort",s),t.aborted&&s(),e.then(n).catch(o)})}async function E(e,t,r){if(typeof e=="function"){let n=e();return n instanceof Promise?{...(await g(n,t,r))?.default}:n}return{...e}}function P(e,t){for(let[r,n]of e)if(Array.isArray(n)){let o=n.indexOf(t);o!==-1&&(n.length===1?e.delete(r):n.splice(o,1))}else n===t&&e.delete(r)}function b(e){function t(a){let c=document.createElement("capsule");return c.innerHTML=a,c}function r(a){let c=a.querySelectorAll("script");for(let u of c)u.remove()}function n(a,c){let u=c.replace(/\s+/g,"").toLowerCase();if(["src","href","xlink:href"].includes(a)&&(u.includes("javascript:")||u.includes("data:text/html"))||a.startsWith("on"))return!0}function o(a){let c=a.attributes;for(let{name:u,value:d}of c)n(u,d)&&a.removeAttribute(u)}function s(a){let c=a.children;for(let u of c)o(u),s(u)}let i=t(e.trim());return r(i),s(i),i.childNodes}var l=(e,t,r="")=>{};var H={};rt(H,{_attr:()=>z,_class:()=>U,_evalHTML:()=>I,_event:()=>J,_html:()=>W,_text:()=>F});var W={update:(e,t)=>{t!==void 0&&(e.innerHTML="",t&&e.append(...b(t)))}};var I={update:(e,t)=>t!==void 0?e.innerHTML=t:""};var U={update:(e,t,r)=>t?e.classList.add(r):e.classList.remove(r)};var F={update:(e,t)=>{t!==void 0&&(e.textContent=t!==Object(t)?t:JSON.stringify(t))}};var z={update:(e,t,r)=>{typeof t=="boolean"?t?e.setAttribute(r,""):e.removeAttribute(r):e.setAttribute(r,t)}};var J={create:(e,t)=>{for(let r in t)e.addEventListener(r,t[r])},destroy:(e,t)=>{for(let r in t)e.removeEventListener(r,t[r])}};var X={refs:[],collect:!1,define(e){return e&&this.refs.every(t=>t.startsWith(this.refs.at(0)))?this.refs.at(-1):[...this.refs]},clear(){this.collect=!1,this.refs.length=0}};var N=class{constructor(t,r,n={},o){this.component=t,this.app=n,this.impress=X,this.proxiesData={},this.context={app:n,container:r,options:t,phase:0,abort:()=>o.abort(),abortSignal:o.signal,node:{},param:{},method:{},proxy:{},source:t.sources||{},directives:{...H,...n.directives,...t.directives}}}async loaded(t){return await this.component.loaded?.bind(this.context)(t)}async rendered(){return typeof this.component!="object"?l(this.context.container.nodepath,211):await this.component.rendered?.bind(this.context)()}async created(){return await this.component.created?.bind(this.context)()}methods(){if(this.component.methods){this.component.outwards?.methods?.length&&(this.context.container.method={});for(let[t,r]of Object.entries(this.component.methods)){if(this.context.method.hasOwnProperty(t))return l(this.context.container.nodepath,212,t);this.context.method[t]=r.bind(this.context),this.component.outwards?.methods?.includes(t)&&(this.context.container.method[t]=(...n)=>{let o=r.bind(this.context)(m(...n));return o instanceof Promise?o.then(s=>m(s)):m(o)})}}Object.preventExtensions(this.context.method)}params(){if(this.component.params){this.component.outwards?.params?.length&&(this.context.container.param={});for(let t in this.component.params){if(this.context.param.hasOwnProperty(t))return l(this.context.container.nodepath,213,t);this.component.outwards?.params?.includes(t)&&(this.context.container.param[t]=this.component.params[t])}Object.assign(this.context.param,this.component.params)}Object.preventExtensions(this.context.param)}proxies(){if(this.component.proxies)for(let t in this.component.proxies){if(t in this.proxiesData)return l(this.context.container.nodepath,214,t);this.proxiesData[t]=this.component.proxies[t]}this.context.proxy=this.getProxy(),Object.preventExtensions(this.context.proxy)}};function L(e,t,r=""){if(!(e&&(e.constructor.name==="Object"||e.constructor.name==="Array")))return e;let n={getPrototypeOf(o){return{target:o,instance:"Proxy"}},get(o,s,i){return t.get?.(o,s,`${r}${s}`),Reflect.get(o,s,i)},set(o,s,i,a){return t.beforeSet(i,`${r}${s}`,u=>{i=u})||!(Reflect.get(o,s,a)!==i||s==="length")||(i=L(i,t,`${r}${s}.`),Reflect.set(o,s,i,a),t.set(o,i,`${r}${s}`)),!0},deleteProperty(o,s){return Reflect.deleteProperty(o,s)},defineProperty(o,s,i){return Reflect.defineProperty(o,s,i)}};e=m(e);for(let o in e)e.hasOwnProperty(o)&&(e[o]=L(e[o],t,`${r}${o}.`));return new Proxy(e,n)}function O(e,t,r){if(!e)return;let n=(o,s)=>{let i=Math.min(o.length,s.length);return o.slice(0,i)===s.slice(0,i)};for(let[o,s]of e)Array.isArray(s)?s.includes(t)&&o(r):n(t,s)&&o(r,t.length>s.length?t.replace(s+".",""):void 0)}var f=(e,t,r="")=>{};var C=class extends N{constructor(t,r,n,o,s){super(t,r,n,o),this.factory=s}async props(){}async mounted(){await this.component.mounted?.bind(this.context)()}actives(t,r){O(t.reactivity?.node,r)}getProxy(){return L(this.proxiesData,{beforeSet:(t,r,n)=>{if(this.component.setters?.[r]){let o=this.component.setters[r].bind(this.context)(t);if(o===void 0)return!0;n(o)}},set:(t,r,n)=>{for(let o in this.context.node)this.actives(this.context.node[o],n,r);this.component.handlers?.[n]?.bind(this.context)(r)},get:(t,r,n)=>{this.impress.collect&&!this.impress.refs.includes(n)&&t.hasOwnProperty(r)&&this.impress.refs.push(n)}})}async nodes(){if(this.component.nodes){let t=this.component.nodes.bind(this.context)(),r=this.context.container,n=r.target;for(let o in t){let s=t[o].selector||this.context.app.selector||`.${o}`,i=typeof s=="function"?s(o):s,a=n.querySelector(i)||n.matches(i)&&n,c=r.nodepath+"."+o;if(a){if(r.spot&&Object.values(r.spot).includes(a)){f(c,107,o);continue}Object.assign(this.context.node,{[o]:{target:a,nodepath:c,nodename:o,directives:{}}})}else f(c,105)}Object.preventExtensions(this.context.node);for await(let[o,s]of Object.entries(this.context.node))await this.factory(t[o],this.context,s,this.impress,this.app).controller()}}};var x=(e,t,r,n,o="")=>{};var S=class{constructor(t,r,n){this.props=t,this.context=r,this.container=r.container,this.app=n}async setup(t){if(this.props.proxies&&Object.keys(this.props.proxies).length&&!t?.proxies)return x(this.container.nodepath,306);if(this.container.proxy||(this.container.proxy={}),t)return await this.params(t.params),await this.methods(t.methods),await this.proxies(t.proxies)}validation(t,r,n,o,s){let i=this.container.nodepath,a=(p,h)=>p&&h&&!(typeof p===h||h==="array"&&Array.isArray(p))&&x(i,s,n,304,h),c=(p,h)=>p&&Array.isArray(h)&&!h.includes(p)&&x(i,s,n,302,p),u=(p,h)=>p??(h.required&&x(i,s,n,303))??h.default??p,d=(p,h)=>typeof h=="string"?a(p,h):(a(p,h.type),c(p,h.enum),u(p,h));return{string:()=>a(o,r),object:()=>{o=d(o,r),r.validate?.(o,d)},function:()=>r(o,d)}[typeof r]?.(),t[n]=o,d}async proxies(t){if(t){let r={},n=this.context;for(let o in t){let s=t[o],i=null;this.container.proxy[o]={getValue:()=>m(n.proxy[o]),setValue:(u,d)=>{d?(j(n.proxy[o],d,m(u)),s.validate?.(n.proxy[o],i)):this.validation(n.proxy,s,o,m(u),"proxies")},isIndependent:()=>this.props.proxies[o]?.hasOwnProperty("_independent")?this.props.proxies[o]._independent:!0};let a=null,{store:c}=s;if(this.props.proxies?.hasOwnProperty(o))a=this.props.proxies[o]?._value;else if(c){let u=await this.app.store?.init(c);if(!u)return x(this.container.nodepath,"proxies",o,307,c);a=u.proxies(o,this.container)}i=this.validation(r,s,o,m(a),"proxies")}return r}}async params(t){for(let r in t){let n=t[r],o=async()=>{let{store:s}=n,i=null;if(s){let a=await this.app.store?.init(s);if(!a)return x(this.container.nodepath,"params",r,307,s);i=a.params(r)}else i=this.props?.params[r];return n?.hole?i:m(i)};this.validation(this.context.param,n,r,await o(),"params"),n.readonly&&Object.defineProperty(this.context.param,r,{writable:!1})}}async methods(t){let r=(n,o)=>{this.context.method[o]=(...s)=>{if(s.length&&(s.length>1||typeof s.at(0)!="object"))return x(this.container.nodepath,"methods",o,301);let i=n({...m(s.at(0)),_params:this.context.container.param,_methods:this.context.container.method});return i instanceof Promise?i.then(a=>m(a)):m(i)}};for(let n in t){let o=t[n],{store:s}=o;if(s){let i=await this.app.store?.init(s);if(!i)return x(this.container.nodepath,"methods",n,307,s);let a=i.methods(n);if(!a)return x(this.container.nodepath,"methods",n,305,s);r(a,n)}else{let i=this.props.methods?.hasOwnProperty(n);if(o?.required&&!i)return x(this.container.nodepath,"methods",n,303);i&&r(this.props.methods[n],n)}}}},B={init(e,t,r,n){return new S(e,r,n).setup(t)}};var $=class extends C{constructor(...t){super(...t)}async props(t){this.proxiesData=await B.init(t,this.component.props,this.context,this.app)||{}}actives(t,r,n){let o=i=>{O(i.reactivity?.node,r),O(i.reactivity?.component,r,n)},s=i=>{for(let a in i.spot)o(i.spot[a]),s(i.spot[a])};o(t),t.children?t.children.forEach(i=>s(i)):s(t)}destroy(t){t.reactivity?.component?.clear(),delete t.proxy,delete t.method;for(let r in t.unstore)t.unstore[r]()}unmount(t){if(this.context.node)for(let r of Object.values(this.context.node)){if(r.directives)for(let n of Object.values(r.directives))n.destroy?.();if(r.reactivity?.node?.clear(),!r.unmount)return;for(let n in r.spot)r.spot[n].unmount?.();r.unmount()}this.component.unmounted?.bind(this.context)(),delete t.unmount}};function V(e){if(!e.mixins?.length)return e;let t=["directives","params","proxies","methods","handlers","setters","sources"],r=["params","proxies","methods"],n=["params","methods"],o=["loaded","rendered","created","mounted","unmounted"],s={props:{},outwards:{params:[],methods:[]},spots:[]},i=[],a={},c=(p,h,v)=>({...p[v],...h[v]}),u=(p,h)=>[...p,...h||[]],d=(p={},h={})=>{for(let v in h)p[v]={...p[v]||{},...h[v]};return p},y=p=>{s.template=p.template||s.template,n.forEach(h=>{s.outwards[h]=u(s.outwards[h],p.outwards?.[h])}),s.spots=u(s.spots,p.spots),t.forEach(h=>{s[h]=c(s,p,h)}),o.forEach(h=>{p[h]&&(s[h]=p[h])}),r.forEach(h=>{s.props[h]=c(s.props,p.props||{},h)}),p.nodes&&i.push(p.nodes)};return s.nodes=function(){return i.forEach(p=>{d(a,p.bind(this)())}),a},e.mixins.forEach(p=>{y(V(p))}),y(e),s}var _={directives(e){let t=this.nodeElement;if(!e.startsWith("_"))return f(t.nodepath,102,e);let r=this.context.directives[e],n=this.nodeOptions[e],{create:o,update:s,destroy:i}=r;Object.assign(t.directives,{[e]:{create:()=>o?o.bind(r)(t.target,n):{},destroy:()=>i?i.bind(r)(t.target,n):{}}}),o&&t.directives[e].create();let a=(c,u,d)=>{let y=p=>s.bind(r)(t.target,p,u,d);typeof c=="function"?(this.impress.collect=!0,y(c(t.target)),this.reactiveNode(this.impress.define(),()=>y(c(t.target)))):y(c)};if(s)if(typeof n=="object")for(let c in n)a(n[c],c,n);else a(n)}};var M={listeners(e){typeof this.nodeOptions[e]=="function"&&(this.nodeElement.target[e]=t=>this.nodeOptions[e].bind(this.context)(t))},general(e){if(e==="innerHTML")return f(this.nodeElement.nodepath,106);let t=r=>{this.nodeElement.target[e]!==null&&typeof this.nodeElement.target[e]=="object"?r!==null&&typeof r=="object"?Object.assign(this.nodeElement.target[e],r):f(this.nodeElement.nodepath,103,e):this.nodeElement.target[e]=r};if(typeof this.nodeOptions[e]=="function"){let r=()=>t(this.nodeOptions[e].bind(this.context)());this.impress.collect=!0,r(),this.reactiveNode(this.impress.define(),r)}else t(this.nodeOptions[e])},native(e){e.startsWith("on")?this.listeners(e):this.general(e)}};var G={async iterative(e){if(typeof e.iterate!="function")return l(this.nodeElement.nodepath,205);if(this.nodeElement.replaced)return l(this.nodeElement.nodepath,204);if(this.name=null,this.repeat=0,this.nodeElement.children=[],this.nodeOptions.component=e,this.nodeElement.clear=()=>this.length.bind(this)(0),this.createIterate=async t=>{this.nodeElement.children[t]=this.nodeElement._current={parent:this.nodeElement,target:!0,nodepath:this.nodeElement.nodepath+"."+t,index:t,iterated:!0},await this.create(this.proxiesIterate.bind(this),this.nodeElement._current,e)},this.impress.collect=!0,this.data=e.iterate(),this.data){if(!Array.isArray(this.data))return l(this.nodeElement.nodepath,205);this.name=this.impress.refs.at(-1),this.impress.clear(),Object.getPrototypeOf(this.data).instance==="Proxy"&&(this.reactiveComponent([this.name],n=>this.length(n.length)),this.reactiveComponent([this.name+".length"],n=>this.length(n)));let t=async()=>{this.data=e.iterate(),await this.length(this.data.length)};this.induced(async n=>n?await t():this.nodeElement.clear())&&await t()}},proxiesIterate(e){let t=this.nodeElement._current,r=(n,o)=>{this.impress.refs.some(s=>s.includes(this.name))?this.reactiveComponent(this.impress.define(n),(s,i)=>{let a=(...c)=>t.proxy?.[n]?.setValue(...c);i?a(s,i):a(o(t))}):this.nodeElement.created?this.impress.clear():this.reactiveComponent(this.impress.define(n),(s,i)=>{let a=this.nodeElement.children,c=u=>{let d=a[u],y=(...p)=>d.proxy?.[n]?.setValue(...p);i?y(s,i):y(o(d))};this.portions(a.length,0,c),this.repeat++})};return this.reactivate(e,r,t)},async portions(e,t,r){if(!e)return;let{portion:n}=this.nodeOptions.component,o=null,s=!1;if(t<e-n){let i=()=>{if(this.repeat>1)return this.repeat--;this.portions(e,t,r)};setTimeout(()=>s?i():new Promise(a=>o=a).then(a=>i()))}do if(await r(t),t++,o&&(n=1),t>=e){this.repeat=0;break}while(t%n!==0);s=!0,o?.()},async length(e){this.repeat++;let t=this.nodeElement.children.length;if(e>t&&await this.portions(e,t,async r=>await this.createIterate(r)),e<t)for(;e<t;){t--;let r=this.nodeElement.children;P(this.nodeElement.reactivity.component,this.name+"."+t),r[t].unmount?.(),r[t].target.remove?.(),r.splice(t,1)}}};var K={async basic(e){this.nodeOptions.component=e;let t=()=>this.create(this.proxies.bind(this),this.nodeElement,e);this.induced(async n=>n?await t():this.nodeElement.unmount?.())&&await t()},proxies(e){if(!e)return;let t=(r,n)=>this.reactiveComponent(this.impress.define(r),(o,s)=>{let i=(...a)=>this.nodeElement.proxy?.[r]?.setValue(...a);s?i(o,s):i(n(this.nodeElement))});return this.reactivate(e,t)}};var Q={collect(e,t){return{params:this.params(e.params,t),methods:this.methods(e.methods)}},methods(e){let t={};if(e)for(let[r,n]of Object.entries(e))typeof n=="function"&&Object.assign(t,{[r]:n});return t},params(e,t){let r={};if(e)for(let[n,o]of Object.entries(e))Object.assign(r,{[n]:typeof o=="function"&&o.name?o(t):o});return r}};var Y={async component(){if(this.nodeElement.reactivity.component=new Map,this.nodeElement.iterated)return l(this.nodeElement.nodepath,208);this.nodeElement.mount=t=>(this.nodeElement.unmount?.(),this.nodeElement.created=!1,t.iterate?this.iterative(t):this.basic(t));let e=()=>this.nodeElement.mount(this.nodeOptions.component);this.nodeElement.replaced=this.nodeOptions.replaced,this.nodeOptions.component.async?e():await e()},induced(e){if(this.nodeOptions.component.hasOwnProperty("induce")){this.nodeElement.induce=e;let t=this.nodeOptions.component.induce;if(!t)return;if(typeof t=="function"){this.impress.collect=!0;let r=t();if(this.reactiveNode(this.impress.define(),async()=>await this.nodeElement.induce(t())),!r)return}}return!0},reactiveComponent(e,t){return this.reactive(e,t,this.nodeElement.reactivity.component)},reactivate(e,t){let r={};if(e)for(let[n,o]of Object.entries(e))if(typeof o=="function"&&o.name){this.impress.collect=!0;let s=c=>o(c),i=o(this.nodeElement._current||this.nodeElement),a=t(n,s);Object.assign(r,{[n]:{_value:i,_independent:!a}})}else Object.assign(r,{[n]:{_value:o,_independent:!0}});return r},async create(e,t,r){let{src:n,spots:o,aborted:s,completed:i}=r;if(n&&(await R(n,t,{aborted:s,completed:i,...Q.collect(r,t),proxies:e(r.proxies)||{}},this.app),this.nodeElement.created=!0,!!o))for await(let[a,c]of Object.entries(o)){if(!t.spot?.hasOwnProperty(a)){l(t.nodepath,202,a);continue}let u=t.spot[a];Object.assign(u,{parent:t,nodepath:t.nodepath+"."+a,nodename:a,spoted:!0}),await A(c,this.context,u,this.impress,this.app).controller()}}};var w=class{constructor(t,r,n,o,s){this.app=s,this.nodeOptions=t,this.context=r,this.impress=o,this.nodeElement=n,this.nodeElement.reactivity={node:new Map}}reactive(t,r,n){return t?.length&&n.set(r,t),this.impress.clear(),t}reactiveNode(t,r){this.reactive(t,r,this.nodeElement.reactivity.node)}controller(){let t=this.nodeElement.nodepath;for(let r in this.nodeOptions){if(this.nodeOptions.replaced&&!["selector","component","replaced"].includes(r))return f(t,109,r);if(r in this.nodeElement.target)this.native(r);else if(r in this.context.directives)this.directives(r);else{if(r==="component")return this.component?.();r==="selector"||r==="replaced"?this.nodeElement.spoted&&f(t,108):f(t,104,r)}}}};function A(...e){return Object.assign(w.prototype,M,_,G,K,Y),new w(...e)}function D(e,t){let r={...t.context.options},n=i=>{let a=typeof i=="function"?i.bind(t.context)():i;return b(a)},o=i=>{if(!i)return l(e.nodepath,210);let a=n(i);return a.length>1?l(e.nodepath,210):a},s=i=>{r.spots?.length&&(i.spot={}),r.spots?.forEach(a=>Object.assign(i.spot,{[a]:{target:i.target.querySelector(`[spot="${a}"]`)}}))};if(e.iterated){let i=e.parent;i.children.length===1&&i.target.childNodes.length&&(i.target.innerHTML="");let a=o(r.template);i.target.append(...a),e.target=i.target.lastChild,s(e),i.unmount||(i.unmount=()=>{t.destroy(i),i.clear()}),e.unmount=()=>{t.destroy(e),t.unmount(e),t.context.abort()}}else{if(e.replaced){let i=o(r.template),a=e.target;e.target.before(...i),e.target=a.previousSibling,a.remove()}else{if(!r.template)return;let i=n(r.template);e.target.innerHTML="",e.target.append(...i)}s(e),e.unmount=()=>{t.destroy(e),t.unmount(e),e.target.innerHTML="",t.context.abort()}}}async function T(e,t,r,n,o){let s=[async()=>await e.loaded(r),async()=>{await e.props(r),e.params(),e.methods(),e.proxies(),await e.created()},async()=>{t(),await e.rendered()},async()=>{await e.nodes(),await e.mounted()}];try{for await(let i of s)await g(i(),e.context.abortSignal),e.context.phase++}catch{n()}return o?.(),e.context.container}async function R(e,t,r={},n={}){let o=new AbortController;t.unmount=()=>o.abort();let s=()=>r.aborted?.({phase:a?a.context.phase:0,reason:o.signal.reason}),i=await E(e,o.signal,s);if(!i)return l(t.nodepath,216);let a=new $(V(i),t,n,o,A);return await T(a,()=>D(t,a),r,s,r.completed)}function q(e={}){let t={};return e.mount=async({options:r,target:n,name:o="root"},s)=>(Object.assign(t,{target:n,nodepath:o}),await R(r,{target:n,nodepath:o},s,e)),e.unmount=()=>t.unmount?.(),Object.preventExtensions(e),e}function tt(...e){return Object.assign(w.prototype,M,_),new w(...e)}async function k({options:e,target:t,name:r="root",completed:n,aborted:o},s={}){if(!e)return l(r,216);if(!t)return l(r,217);let i={...e},a=new AbortController,c={target:t,nodepath:r,unmount(){a.abort(),t.innerHTML=""}},u=new C(i,c,s,a,tt);return await T(u,()=>{i.template&&(t.innerHTML=b(i.template)),u.context.container=c},{},()=>o?.({phase:u.context.phase,reason:a.signal.reason}),n)}window.lesta={createApp:q,mountWidget:k,replicate:m,deliver:j,deleteReactive:P,cleanHTML:b,loadModule:E,revocablePromise:g};})();
