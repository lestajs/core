(()=>{var Z=Object.defineProperty;var tt=(e,t)=>{for(var r in t)Z(e,r,{get:t[r],enumerable:!0})};function l(e){return e?typeof e=="object"?JSON.parse(JSON.stringify(e)):e:e??null}function O(e,t=[],r){let n=Array.isArray(t)?t:t.split("."),o;try{for(o=0;o<n.length-1;o++)e=e[n[o]];return r!==void 0&&(e[n[o]]=r),e[n[o]]}catch{}}async function g(e,t){if(typeof e=="function"){let r=e();return!(r instanceof Promise)||t?.aborted?void 0:{...(await(async()=>t?t.aborted?void 0:await Promise.race([r,new Promise(s=>t.addEventListener("abort",()=>s()))]):await r)())?.default}}return{...e}}function v(e,t){for(let[r,n]of e)if(Array.isArray(n)){let o=n.indexOf(t);o!==-1&&(n.length===1?e.delete(r):n.splice(o,1))}else n===t&&e.delete(r)}function b(e){function t(a){let c=document.createElement("capsule");return c.innerHTML=a,c}function r(a){let c=a.querySelectorAll("script");for(let h of c)h.remove()}function n(a,c){let h=c.replace(/\s+/g,"").toLowerCase();if(["src","href","xlink:href"].includes(a)&&(h.includes("javascript:")||h.includes("data:text/html"))||a.startsWith("on"))return!0}function o(a){let c=a.attributes;for(let{name:h,value:u}of c)n(h,u)&&a.removeAttribute(h)}function s(a){let c=a.children;for(let h of c)o(h),s(h)}let i=t(e);return r(i),s(i),i.childNodes}var d=(e,t,r="")=>{};var R={};tt(R,{_attr:()=>k,_class:()=>W,_evalHTML:()=>q,_event:()=>z,_html:()=>I,_text:()=>U});var I={update:(e,t)=>{t!==void 0&&(e.innerHTML="",t&&e.append(...b(t)))}};var q={update:(e,t)=>t!==void 0?e.innerHTML=t:""};var W={update:(e,t,r)=>t?e.classList.add(r):e.classList.remove(r)};var U={update:(e,t)=>{t!==void 0&&(e.textContent=t!==Object(t)?t:JSON.stringify(t))}};var k={update:(e,t,r)=>{typeof t=="boolean"?t?e.setAttribute(r,""):e.removeAttribute(r):e.setAttribute(r,t)}};var z={create:(e,t)=>{for(let r in t)e.addEventListener(r,t[r])},destroy:(e,t)=>{for(let r in t)e.removeEventListener(r,t[r])}};var F={refs:[],collect:!1,define(e){return e&&this.refs.every(t=>t.startsWith(this.refs.at(0)))?this.refs.at(-1):[...this.refs]},clear(){this.collect=!1,this.refs.length=0}};var L=class{constructor(t,r,n={},o){this.component=t,this.app=n,this.impress=F,this.proxiesData={},this.context={app:n,container:r,options:t,phase:0,abortSignal:o,node:{},param:{},method:{},proxy:{},source:t.sources||{},directives:{...R,...n.directives,...t.directives}}}async loaded(t){return await this.component.loaded?.bind(this.context)(t)}async rendered(){return typeof this.component!="object"?d(this.context.container.nodepath,211):await this.component.rendered?.bind(this.context)()}async created(){return await this.component.created?.bind(this.context)()}methods(){if(this.component.methods){this.component.outwards?.methods?.length&&(this.context.container.method={});for(let[t,r]of Object.entries(this.component.methods)){if(this.context.method.hasOwnProperty(t))return d(this.context.container.nodepath,212,t);this.context.method[t]=r.bind(this.context),this.component.outwards?.methods?.includes(t)&&(this.context.container.method[t]=(...n)=>{let o=r.bind(this.context)(l(...n));return o instanceof Promise?o.then(s=>l(s)):l(o)})}}Object.preventExtensions(this.context.method)}params(){if(this.component.params){this.component.outwards?.params?.length&&(this.context.container.param={});for(let t in this.component.params){if(this.context.param.hasOwnProperty(t))return d(this.context.container.nodepath,213,t);this.component.outwards?.params?.includes(t)&&(this.context.container.param[t]=this.component.params[t])}Object.assign(this.context.param,this.component.params)}Object.preventExtensions(this.context.param)}proxies(){if(this.component.proxies)for(let t in this.component.proxies){if(t in this.proxiesData)return d(this.context.container.nodepath,214,t);this.proxiesData[t]=this.component.proxies[t]}this.context.proxy=this.getProxy(),Object.preventExtensions(this.context.proxy)}};function j(e,t,r=""){if(!(e&&(e.constructor.name==="Object"||e.constructor.name==="Array")))return e;let n={getPrototypeOf(o){return{target:o,instance:"Proxy"}},get(o,s,i){return t.get?.(o,s,`${r}${s}`),Reflect.get(o,s,i)},set(o,s,i,a){return t.beforeSet(i,`${r}${s}`,h=>{i=h})||!(Reflect.get(o,s,a)!==i||s==="length")||(i=j(i,t,`${r}${s}.`),Reflect.set(o,s,i,a),t.set(o,i,`${r}${s}`)),!0},deleteProperty(o,s){return Reflect.deleteProperty(o,s)},defineProperty(o,s,i){return Reflect.defineProperty(o,s,i)}};e=l(e);for(let o in e)e.hasOwnProperty(o)&&(e[o]=j(e[o],t,`${r}${o}.`));return new Proxy(e,n)}function E(e,t,r){if(!e)return;let n=(o,s)=>{let i=Math.min(o.length,s.length);return o.slice(0,i)===s.slice(0,i)};for(let[o,s]of e)Array.isArray(s)?s.includes(t)&&o(r):n(t,s)&&o(r,t.length>s.length?t.replace(s+".",""):void 0)}var x=(e,t,r="")=>{};var P=class extends L{constructor(t,r,n,o,s){super(t,r,n,o),this.factory=s}async props(){}async mounted(){await this.component.mounted?.bind(this.context)()}actives(t,r){E(t.reactivity?.node,r)}getProxy(){return j(this.proxiesData,{beforeSet:(t,r,n)=>{if(this.component.setters?.[r]){let o=this.component.setters[r].bind(this.context)(t);if(o===void 0)return!0;n(o)}},set:(t,r,n)=>{for(let o in this.context.node)this.actives(this.context.node[o],n,r);this.component.handlers?.[n]?.bind(this.context)(r)},get:(t,r,n)=>{this.impress.collect&&!this.impress.refs.includes(n)&&t.hasOwnProperty(r)&&this.impress.refs.push(n)}})}async nodes(){if(this.component.nodes){let t=this.component.nodes.bind(this.context)(),r=this.context.container,n=r.target;for(let o in t){let s=t[o].selector||this.context.app.selector||`.${o}`,i=typeof s=="function"?s(o):s,a=n.querySelector(i)||n.matches(i)&&n,c=r.nodepath+"."+o;if(a){if(r.spot&&Object.values(r.spot).includes(a)){x(c,107,o);continue}Object.assign(this.context.node,{[o]:{target:a,nodepath:c,nodename:o,directives:{}}})}else x(c,105)}Object.preventExtensions(this.context.node);for await(let[o,s]of Object.entries(this.context.node))await this.factory(t[o],this.context,s,this.impress,this.app).controller()}}};var y=(e,t,r,n,o="")=>{};var S=class{constructor(t,r,n){this.props=t,this.context=r,this.container=r.container,this.app=n}async setup(t){if(this.props.proxies&&Object.keys(this.props.proxies).length&&!t?.proxies)return y(this.container.nodepath,306);if(this.container.proxy||(this.container.proxy={}),t)return await this.params(t.params),await this.methods(t.methods),await this.proxies(t.proxies)}validation(t,r,n,o,s){let i=this.container.nodepath,a=(p,m)=>p&&m&&!(typeof p===m||m==="array"&&Array.isArray(p))&&y(i,s,n,304,m),c=(p,m)=>p&&Array.isArray(m)&&!m.includes(p)&&y(i,s,n,302,p),h=(p,m)=>p??(m.required&&y(i,s,n,303))??m.default??p,u=(p,m)=>typeof m=="string"?a(p,m):(a(p,m.type),c(p,m.enum),h(p,m));return{string:()=>a(o,r),object:()=>{o=u(o,r),r.validate?.(o,u)},function:()=>r(o,u)}[typeof r]?.(),t[n]=o,u}async proxies(t){if(t){let r={},n=this.context;for(let o in t){let s=t[o],i=null;this.container.proxy[o]={getValue:()=>l(n.proxy[o]),setValue:(h,u)=>{u?(O(n.proxy[o],u,l(h)),s.validate?.(n.proxy[o],i)):this.validation(n.proxy,s,o,l(h),"proxies")},isIndependent:()=>this.props.proxies[o]?.hasOwnProperty("_independent")?this.props.proxies[o]._independent:!0};let a=null,{store:c}=s;if(this.props.proxies?.hasOwnProperty(o))a=this.props.proxies[o]?._value;else if(c){let h=await this.app.store?.init(c);if(!h)return y(this.container.nodepath,"proxies",o,307,c);a=h.proxies(o,this.container)}i=this.validation(r,s,o,l(a),"proxies")}return r}}async params(t){for(let r in t){let n=t[r],o=async()=>{let{store:s}=n,i=null;if(s){let a=await this.app.store?.init(s);if(!a)return y(this.container.nodepath,"params",r,307,s);i=a.params(r)}else i=this.props?.params[r];return n?.hole?i:l(i)};this.validation(this.context.param,n,r,await o(),"params"),n.readonly&&Object.defineProperty(this.context.param,r,{writable:!1})}}async methods(t){let r=(n,o)=>{this.context.method[o]=(...s)=>{if(s.length&&(s.length>1||typeof s.at(0)!="object"))return y(this.container.nodepath,"methods",o,301);let i=n({...l(s.at(0)),_params:this.context.container.param,_methods:this.context.container.method});return i instanceof Promise?i.then(a=>l(a)):l(i)}};for(let n in t){let o=t[n],{store:s}=o;if(s){let i=await this.app.store?.init(s);if(!i)return y(this.container.nodepath,"methods",n,307,s);let a=i.methods(n);if(!a)return y(this.container.nodepath,"methods",n,305,s);r(a,n)}else{let i=this.props.methods?.hasOwnProperty(n);if(o?.required&&!i)return y(this.container.nodepath,"methods",n,303);i&&r(this.props.methods[n],n)}}}},J={async init(e,t,r,n){return await new S(e,r,n).setup(t)}};var C=class extends P{constructor(...t){super(...t)}async props(t){this.proxiesData=await J.init(t,this.component.props,this.context,this.app)||{}}actives(t,r,n){let o=i=>{E(i.reactivity?.node,r),E(i.reactivity?.component,r,n)},s=i=>{for(let a in i.spot)o(i.spot[a]),s(i.spot[a])};o(t),t.children?t.children.forEach(i=>s(i)):s(t)}destroy(t){t.reactivity?.component?.clear(),delete t.proxy,delete t.method;for(let r in t.unstore)t.unstore[r]()}unmount(t){if(this.context.node)for(let r of Object.values(this.context.node)){if(r.directives)for(let n of Object.values(r.directives))n.destroy?.();if(r.reactivity?.node?.clear(),!r.unmount)return;for(let n in r.spot)r.spot[n].unmount?.();r.unmount()}this.component.unmounted?.bind(this.context)(),delete t.unmount}};function T(e){if(e.mixins?.length){let t=["directives","params","proxies","methods","handlers","setters","sources"],r=["params","proxies","methods"],n=["params","methods"],o=["loaded","rendered","created","mounted","unmounted"],s={props:{},outwards:{params:[],methods:[]},spots:[]},i=(u,f,p)=>({...u[p],...f[p]}),a=(u,f)=>[...u,...f||[]],c=(u={},f={})=>{let p={};for(let m in f)p[m]={...u[m]||{},...f[m]};return p},h=u=>{s.template=u.template||s.template,n.forEach(p=>{s.outwards[p]=a(s.outwards[p],u.outwards?.[p])}),s.spots=a(s.spots,u.spots),t.forEach(p=>{s[p]=i(s,u,p)}),o.forEach(p=>{u[p]&&(s[p]=u[p])}),r.forEach(p=>{s.props[p]=i(s.props,u.props||{},p)});let f=s.nodes;s.nodes=function(){return c(f?.bind(this)(),u.nodes?.bind(this)())}};return e.mixins.forEach(u=>{h(T(u))}),h(e),s}return e}var N={directives(e){let t=this.nodeElement;if(!e.startsWith("_"))return x(t.nodepath,102,e);let r=this.context.directives[e],n=this.nodeOptions[e],{create:o,update:s,destroy:i}=r;Object.assign(t.directives,{[e]:{create:()=>o?o.bind(r)(t.target,n):{},destroy:()=>i?i.bind(r)(t.target,n):{}}}),o&&t.directives[e].create();let a=(c,h,u)=>{let f=p=>s.bind(r)(t.target,p,h,u);typeof c=="function"?(this.impress.collect=!0,f(c(t.target)),this.reactiveNode(this.impress.define(),()=>f(c(t.target)))):f(c)};if(s)if(typeof n=="object")for(let c in n)a(n[c],c,n);else a(n)}};var $={listeners(e){typeof this.nodeOptions[e]=="function"&&(this.nodeElement.target[e]=t=>this.nodeOptions[e].bind(this.context)(t))},general(e){if(e==="innerHTML")return x(this.nodeElement.nodepath,106);if(typeof this.nodeOptions[e]=="function"){let t=()=>{let r=this.nodeOptions[e].bind(this.context)();this.nodeElement.target[e]!==null&&typeof this.nodeElement.target[e]=="object"?r!==null&&typeof r=="object"?Object.assign(this.nodeElement.target[e],r):x(this.nodeElement.nodepath,103,e):this.nodeElement.target[e]=r};this.impress.collect=!0,t(),this.reactiveNode(this.impress.define(),t)}else this.nodeElement.target[e]=this.nodeOptions[e]},native(e){e.startsWith("on")?this.listeners(e):this.general(e)}};var X={async iterative(e){if(typeof e.iterate!="function")return d(this.nodeElement.nodepath,205);if(this.name=null,this.nodeElement.children=[],this.nodeOptions.component=e,this.nodeElement.clear=()=>this.length.bind(this)(0),this.createIterate=async t=>{this.nodeElement.children[t]=this.nodeElement._current={parent:this.nodeElement,target:!0,nodepath:this.nodeElement.nodepath+"."+t,index:t,isIterable:!0},await this.create(this.proxiesIterate.bind(this),this.nodeElement.children[t],e)},this.impress.collect=!0,this.data=e.iterate(),this.data){if(!Array.isArray(this.data))return d(this.nodeElement.nodepath,206);this.name=this.impress.refs.at(-1),this.impress.clear(),this.nodeElement.isIterative=!0,Object.getPrototypeOf(this.data).instance==="Proxy"&&(this.reactiveComponent([this.name],n=>{if(this.data=e.iterate(),e.proxies){for(let[o,s]of Object.entries(e.proxies))if(typeof s=="function"&&s.name)for(let i=0;i<Math.min(this.nodeElement.target.children.length,n.length);i++)this.nodeElement.children[i]?.proxy?.[o]?.setValue(s(this.nodeElement.children[i]))}this.length(n.length)}),this.reactiveComponent([this.name+".length"],n=>this.length(n)));let t=async()=>{this.data=e.iterate(),await this.length(this.data.length)};this.induced(async n=>n?await t():this.nodeElement.clear())&&await t()}},proxiesIterate(e){let t=this.nodeElement._current,r=(n,o)=>{this.impress.refs.some(s=>s.includes(this.name))?this.reactiveComponent(this.impress.define(n),(s,i)=>{t.proxy&&(i?t.proxy[n]?.setValue(s,i):t.proxy[n]?.setValue(o(t)))}):this.nodeElement.created?this.impress.clear():this.reactiveComponent(this.impress.define(n),(s,i)=>{for(let a=0;a<this.nodeElement.target.children.length;a++){let c=this.nodeElement.children[a];i?c.proxy?.[n]?.setValue(s,i):c.proxy?.[n]?.setValue(o(c))}})};return this.reactivate(e,r,t)},async length(e){let t=this.nodeElement.children.length;e>t&&await this.add(e,t),e<t&&this.remove(e,t)},async add(e,t){for(;e>t;){if(await this.createIterate(t),!this.nodeElement.target.children[t])return;t++}},remove(e,t){for(;e<t;)t--,v(this.nodeElement.reactivity.component,this.name+"."+t),this.nodeElement.children[t].unmount?.(),this.nodeElement.children[t].target.remove(),this.nodeElement.children.splice(t,1)}};var Q={async basic(e){this.nodeOptions.component=e;let t=async()=>await this.create(this.proxies.bind(this),this.nodeElement,e);this.induced(async n=>n?await t():this.nodeElement.unmount?.())&&await t()},proxies(e){if(!e)return;let t=(r,n)=>this.reactiveComponent(this.impress.define(r),(o,s)=>{s?this.nodeElement.proxy?.[r]?.setValue(o,s):this.nodeElement.proxy?.[r]?.setValue(n(this.nodeElement))});return this.reactivate(e,t)}};var B={collect(e,t){return{params:this.params(e.params,t),methods:this.methods(e.methods)}},methods(e){let t={};if(e)for(let[r,n]of Object.entries(e))typeof n=="function"&&Object.assign(t,{[r]:n});return t},params(e,t){let r={};if(e)for(let[n,o]of Object.entries(e))Object.assign(r,{[n]:typeof o=="function"&&o.name?o(t):o});return r}};var G={async component(){if(this.nodeElement.reactivity.component=new Map,this.nodeElement.isIterable)return d(this.nodeElement.nodepath,208);this.nodeElement.mount=async e=>{this.nodeElement.unmount?.(),this.nodeElement.created=!1,e.iterate?await this.iterative(e):await this.basic(e)},this.nodeElement.prepared=this.nodeOptions.prepared,this.nodeOptions.component.async?this.nodeElement.mount(this.nodeOptions.component):await this.nodeElement.mount(this.nodeOptions.component)},induced(e){if(this.nodeOptions.component.hasOwnProperty("induce")){this.nodeElement.induce=e;let t=this.nodeOptions.component.induce;if(!t)return;if(typeof t=="function"){this.impress.collect=!0;let r=t();if(this.reactiveNode(this.impress.define(),async()=>await this.nodeElement.induce(t())),!r)return}}return!0},reactiveComponent(e,t){return this.reactive(e,t,this.nodeElement.reactivity.component)},reactivate(e,t){let r={};if(e)for(let[n,o]of Object.entries(e))if(typeof o=="function"&&o.name){this.impress.collect=!0;let s=c=>o(c),i=o(this.nodeElement._current||this.nodeElement),a=t(n,s);Object.assign(r,{[n]:{_value:i,_independent:!a}})}else Object.assign(r,{[n]:{_value:o,_independent:!0}});return r},async create(e,t,r){let{src:n,spots:o,aborted:s,completed:i}=r;if(n&&(await _(n,t,{aborted:s,completed:i,...B.collect(r,t),proxies:e(r.proxies)||{}},this.app),this.nodeElement.created=!0,!!o))for await(let[a,c]of Object.entries(o)){if(!t.spot?.hasOwnProperty(a)){d(t.nodepath,202,a);continue}let h=t.spot[a];Object.assign(h,{parent:t,nodepath:t.nodepath+"."+a,nodename:a,isSpot:!0}),await M(c,this.context,h,this.impress,this.app).controller()}}};var w=class{constructor(t,r,n,o,s){this.app=s,this.nodeOptions=t,this.context=r,this.impress=o,this.nodeElement=n,this.nodeElement.reactivity={node:new Map}}reactive(t,r,n){return t?.length&&n.set(r,t),this.impress.clear(),t}reactiveNode(t,r){this.reactive(t,r,this.nodeElement.reactivity.node)}async controller(){for(let t in this.nodeOptions){if(this.nodeOptions.prepared&&!["selector","component","prepared"].includes(t))return x(this.nodeElement.nodepath,109,t);t in this.nodeElement.target?this.native(t):t in this.context.directives?this.directives(t):t==="component"?await this.component?.():t==="selector"||t==="prepared"?this.nodeElement.isSpot&&x(this.nodeElement.nodepath,108):x(this.nodeElement.nodepath,104,t)}}};function M(...e){return Object.assign(w.prototype,$,N,X,Q,G),new w(...e)}function H(e,t,r){let n={...t.context.options};if(!n.template)return d(e.nodepath,209);let o=i=>{let a=typeof i=="function"?i.bind(t.context)():i,c=b(a.trim());return(e.isIterable||e.prepared)&&c.length>1?d(e.nodepath,210):c},s=i=>{n.spots?.length&&(i.spot={}),n.spots?.forEach(a=>Object.assign(i.spot,{[a]:{target:i.target.querySelector(`[spot="${a}"]`)}}))};if(e.isIterable){let i=e.parent;i.children.length===1&&i.target.childNodes.length&&(i.target.innerHTML="");let a=o(n.template);i.target.append(...a),e.target=i.target.lastChild,s(e),i.unmount||(i.unmount=()=>{t.destroy(i),i.clear(),delete i.unmount}),e.unmount=()=>{t.destroy(e),t.unmount(e),r.abort()}}else{if(e.prepared){let i=o(n.template),a=e.target;e.target.before(...i),e.target=a.previousSibling,a.remove()}else{let i=o(n.template);e.target.innerHTML="",i&&e.target.append(...i)}s(e),e.unmount=()=>{t.destroy(e),t.unmount(e),e.target.innerHTML="",r.abort()}}}async function A(e,t,r){let n=[async()=>{e.context.props=r,await e.loaded()},async()=>(await e.props(r),e.params(),e.methods(),e.proxies(),delete e.context.props,await e.created()),async()=>(t(),await e.rendered()),async()=>(await e.nodes(),await e.mounted())],o=s=>({container:e.context.container,phase:e.context.phase,data:s});for await(let s of n){let i=await s();if(e.context.phase++,e.context.abortSignal?.aborted||i){r.aborted?.(o(l(i)));return}}return r.completed?.(o(null)),e.context.container}async function _(e,t,r,n={}){let o=new AbortController,s=o.signal,i=await g(e,s);if(!i)return d(t.nodepath,216);let a=new C(T(i),t,n,s,M);return await A(a,()=>H(t,a,o),r)}function V(e={}){let t={};return e.mount=async({options:r,target:n,name:o="root",props:s={}})=>(Object.assign(t,{target:n,nodepath:o}),await _(r,{target:n,nodepath:o},s,e)),e.unmount=()=>t.unmount?.(),Object.preventExtensions(e),e}function Y(...e){return Object.assign(w.prototype,$,N),new w(...e)}async function D({options:e,target:t,name:r="root",aborted:n,completed:o}){if(!e)return d(r,216);if(!t)return d(r,217);let s={...e},i=new AbortController,a=i.signal,c={target:t,nodepath:r,unmount(){delete h.context.container,t.innerHTML="",i.abort()}},h=new P(s,c,{},a,Y);return await A(h,()=>{t.innerHTML=s.template,h.context.container=c},{aborted:n,completed:o})}window.lesta={createApp:V,mountWidget:D,replicate:l,deliver:O,deleteReactive:v,cleanHTML:b,loadModule:g};})();
