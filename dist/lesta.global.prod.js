(()=>{var tt=Object.defineProperty;var et=(e,t)=>{for(var r in t)tt(e,r,{get:t[r],enumerable:!0})};function m(e){return e?typeof e=="object"?JSON.parse(JSON.stringify(e)):e:e??null}function v(e,t=[],r){let o=Array.isArray(t)?t:t.split("."),n;try{for(n=0;n<o.length-1;n++)e=e[o[n]];return r!==void 0&&(e[o[n]]=r),e[o[n]]}catch{}}async function w(e,t,r){return new Promise((o,n)=>{let s=()=>{n(),r?.(),t.removeEventListener("abort",s)};t.addEventListener("abort",s),t.aborted&&s(),e.then(o).catch(n)})}async function g(e,t,r){if(typeof e=="function"){let o=e();return o instanceof Promise?{...(await w(o,t,r))?.default}:o}return{...e}}function j(e,t){for(let[r,o]of e)if(Array.isArray(o)){let n=o.indexOf(t);n!==-1&&(o.length===1?e.delete(r):o.splice(n,1))}else o===t&&e.delete(r)}function P(e){function t(a){let c=document.createElement("capsule");return c.innerHTML=a,c}function r(a){let c=a.querySelectorAll("script");for(let u of c)u.remove()}function o(a,c){let u=c.replace(/\s+/g,"").toLowerCase();if(["src","href","xlink:href"].includes(a)&&(u.includes("javascript:")||u.includes("data:text/html"))||a.startsWith("on"))return!0}function n(a){let c=a.attributes;for(let{name:u,value:f}of c)o(u,f)&&a.removeAttribute(u)}function s(a){let c=a.children;for(let u of c)n(u),s(u)}let i=t(e.trim());return r(i),s(i),i.childNodes}var l=(e,t,r="")=>{};var V={};et(V,{_attr:()=>F,_class:()=>I,_event:()=>z,_text:()=>U});var I={update:(e,t,r)=>t?e.classList.add(r):e.classList.remove(r)};var U={update:(e,t)=>{t!==void 0&&(e.textContent=t!==Object(t)?t:JSON.stringify(t))}};var F={update:(e,t,r)=>{typeof t=="boolean"?t?e.setAttribute(r,""):e.removeAttribute(r):e.setAttribute(r,t)}};var z={create:(e,t)=>{for(let r in t)e.addEventListener(r,t[r])},destroy:(e,t)=>{for(let r in t)e.removeEventListener(r,t[r])}};var J={refs:[],collect:!1,define(e){return e&&this.refs.every(t=>t.startsWith(this.refs.at(0)))?this.refs.at(-1):[...this.refs]},clear(){this.collect=!1,this.refs.length=0}};var $=class{constructor(t,r,o={},n){this.component=t,this.app=o,this.impress=J,this.proxiesData={},this.context={app:o,container:r,options:t,phase:0,abort:()=>n.abort(),abortSignal:n.signal,node:{},param:{},method:{},proxy:{},source:t.sources||{},directives:{...V,...o.directives,...t.directives}}}async loaded(t){return await this.component.loaded?.bind(this.context)(t)}async rendered(){return typeof this.component!="object"?l(this.context.container.nodepath,211):await this.component.rendered?.bind(this.context)()}async created(){return await this.component.created?.bind(this.context)()}methods(){if(this.component.methods){this.component.outwards?.methods?.length&&(this.context.container.method={});for(let[t,r]of Object.entries(this.component.methods)){if(this.context.method.hasOwnProperty(t))return l(this.context.container.nodepath,212,t);this.context.method[t]=r.bind(this.context),this.component.outwards?.methods?.includes(t)&&(this.context.container.method[t]=(...o)=>{let n=r.bind(this.context)(m(...o));return n instanceof Promise?n.then(s=>m(s)):m(n)})}}Object.preventExtensions(this.context.method)}params(){if(this.component.params){this.component.outwards?.params?.length&&(this.context.container.param={});for(let t in this.component.params){if(this.context.param.hasOwnProperty(t))return l(this.context.container.nodepath,213,t);this.component.outwards?.params?.includes(t)&&(this.context.container.param[t]=this.component.params[t])}Object.assign(this.context.param,this.component.params)}Object.preventExtensions(this.context.param)}proxies(){if(this.component.proxies)for(let t in this.component.proxies){if(t in this.proxiesData)return l(this.context.container.nodepath,214,t);this.proxiesData[t]=this.component.proxies[t]}this.context.proxy=this.getProxy(),Object.preventExtensions(this.context.proxy)}};function L(e,t,r=""){if(!(e&&(e.constructor.name==="Object"||e.constructor.name==="Array")))return e;let o={getPrototypeOf(n){return{target:n,instance:"Proxy"}},get(n,s,i){return t.get?.(n,s,`${r}${s}`),Reflect.get(n,s,i)},set(n,s,i,a){return t.beforeSet(i,`${r}${s}`,u=>{i=u})||!(Reflect.get(n,s,a)!==i||s==="length")||(i=L(i,t,`${r}${s}.`),Reflect.set(n,s,i,a),t.set(n,i,`${r}${s}`)),!0},deleteProperty(n,s){return Reflect.deleteProperty(n,s)},defineProperty(n,s,i){return Reflect.defineProperty(n,s,i)}};e=m(e);for(let n in e)e.hasOwnProperty(n)&&(e[n]=L(e[n],t,`${r}${n}.`));return new Proxy(e,o)}function E(e,t,r){if(!e)return;let o=(n,s)=>{let i=Math.min(n.length,s.length);return n.slice(0,i)===s.slice(0,i)};for(let[n,s]of e)Array.isArray(s)?s.includes(t)&&n(r):o(t,s)&&n(r,t.length>s.length?t.replace(s+".",""):void 0)}var d=(e,t,r="")=>{};var N=class extends ${constructor(t,r,o,n,s){super(t,r,o,n),this.factory=s}async props(){}async mounted(){await this.component.mounted?.bind(this.context)()}actives(t,r){E(t.reactivity?.node,r)}getProxy(){return L(this.proxiesData,{beforeSet:(t,r,o)=>{if(this.component.setters?.[r]){let n=this.component.setters[r].bind(this.context)(t);if(n===void 0)return!0;o(n)}},set:(t,r,o)=>{for(let n in this.context.node)this.actives(this.context.node[n],o,r);this.component.handlers?.[o]?.bind(this.context)(r)},get:(t,r,o)=>{this.impress.collect&&!this.impress.refs.includes(o)&&t.hasOwnProperty(r)&&this.impress.refs.push(o)}})}async nodes(){if(this.component.nodes){let t=this.component.nodes.bind(this.context)(),r=this.context.container,o=r.target;for(let n in t){let s=t[n].selector||this.context.app.selector||`.${n}`,i=typeof s=="function"?s(n):s,a=o.querySelector(i)||o.matches(i)&&o,c=r.nodepath+"."+n;if(a){if(a._engaged)return d(c,106,n);if(a._engaged=!0,r.spot&&Object.values(r.spot).includes(a)){d(c,107,n);continue}Object.assign(this.context.node,{[n]:{target:a,nodepath:c,nodename:n,directives:{}}})}else d(c,105)}Object.preventExtensions(this.context.node);for await(let[n,s]of Object.entries(this.context.node))await this.factory(t[n],this.context,s,this.impress,this.app).controller()}}};var x=(e,t,r,o,n="")=>{};var H=class{constructor(t,r,o){this.props=t,this.context=r,this.container=r.container,this.app=o}async setup(t){if(this.props.proxies&&Object.keys(this.props.proxies).length&&!t?.proxies)return x(this.container.nodepath,306);if(this.container.proxy||(this.container.proxy={}),t)return await this.params(t.params),await this.methods(t.methods),await this.proxies(t.proxies)}validation(t,r,o,n,s){let i=this.container.nodepath,a=(p,h)=>p&&h&&!(typeof p===h||h==="array"&&Array.isArray(p))&&x(i,s,o,304,h),c=(p,h)=>p&&Array.isArray(h)&&!h.includes(p)&&x(i,s,o,302,p),u=(p,h)=>p??(h.required&&x(i,s,o,303))??h.default??p,f=(p,h)=>typeof h=="string"?a(p,h):(a(p,h.type),c(p,h.enum),u(p,h));return{string:()=>a(n,r),object:()=>{n=f(n,r),r.validate?.(n,f)},function:()=>r(n,f)}[typeof r]?.(),t[o]=n,f}async proxies(t){if(t){let r={},o=this.context;for(let n in t){let s=t[n],i=null;this.container.proxy[n]={getValue:()=>m(o.proxy[n]),setValue:(u,f)=>{f?(v(o.proxy[n],f,m(u)),s.validate?.(o.proxy[n],i)):this.validation(o.proxy,s,n,m(u),"proxies")},isIndependent:()=>this.props.proxies[n]?.hasOwnProperty("_independent")?this.props.proxies[n]._independent:!0};let a=null,{store:c}=s;if(this.props.proxies?.hasOwnProperty(n))a=this.props.proxies[n]?._value;else if(c){let u=await this.app.store?.init(c);if(!u)return x(this.container.nodepath,"proxies",n,307,c);a=u.proxies(n,this.container)}i=this.validation(r,s,n,m(a),"proxies")}return r}}async params(t){for(let r in t){let o=t[r],n=async()=>{let{store:s}=o,i=null;if(s){let a=await this.app.store?.init(s);if(!a)return x(this.container.nodepath,"params",r,307,s);i=a.params(r)}else i=this.props?.params[r];return o?.hole?i:m(i)};this.validation(this.context.param,o,r,await n(),"params"),o.readonly&&Object.defineProperty(this.context.param,r,{writable:!1})}}async methods(t){let r=(o,n)=>{this.context.method[n]=(...s)=>{if(s.length&&(s.length>1||typeof s.at(0)!="object"))return x(this.container.nodepath,"methods",n,301);let i=o({...m(s.at(0)),_params:this.context.container.param,_methods:this.context.container.method});return i instanceof Promise?i.then(a=>m(a)):m(i)}};for(let o in t){let n=t[o],{store:s}=n;if(s){let i=await this.app.store?.init(s);if(!i)return x(this.container.nodepath,"methods",o,307,s);let a=i.methods(o);if(!a)return x(this.container.nodepath,"methods",o,305,s);r(a,o)}else{let i=this.props.methods?.hasOwnProperty(o);if(n?.required&&!i)return x(this.container.nodepath,"methods",o,303);i&&r(this.props.methods[o],o)}}}},B={init(e,t,r,o){return new H(e,r,o).setup(t)}};var _=class extends N{constructor(...t){super(...t)}async props(t){this.proxiesData=await B.init(t,this.component.props,this.context,this.app)||{}}actives(t,r,o){let n=i=>{E(i.reactivity?.node,r),E(i.reactivity?.component,r,o)},s=i=>{for(let a in i.spot)n(i.spot[a]),s(i.spot[a])};n(t),t.children?t.children.forEach(i=>s(i)):s(t)}destroy(t){t.reactivity?.component?.clear(),delete t.proxy,delete t.method;for(let r in t.unstore)t.unstore[r]()}unmount(t){if(this.context.node)for(let r of Object.values(this.context.node)){if(r.directives)for(let o of Object.values(r.directives))o.destroy?.();if(r.reactivity?.node?.clear(),!r.unmount)return;for(let o in r.spot)r.spot[o].unmount?.();r.unmount()}this.component.unmounted?.bind(this.context)(),delete t.unmount}};function D(e){if(!e.mixins?.length)return e;let t=["directives","params","proxies","methods","handlers","setters","sources"],r=["params","proxies","methods"],o=["params","methods"],n=["loaded","rendered","created","mounted","unmounted"],s={props:{},outwards:{params:[],methods:[]},spots:[]},i=[],a={},c=(p,h,O)=>({...p[O],...h[O]}),u=(p,h)=>[...p,...h||[]],f=(p={},h={})=>{for(let O in h)p[O]={...p[O]||{},...h[O]};return p},y=p=>{s.template=p.template||s.template,o.forEach(h=>{s.outwards[h]=u(s.outwards[h],p.outwards?.[h])}),s.spots=u(s.spots,p.spots),t.forEach(h=>{s[h]=c(s,p,h)}),n.forEach(h=>{p[h]&&(s[h]=p[h])}),r.forEach(h=>{s.props[h]=c(s.props,p.props||{},h)}),p.nodes&&i.push(p.nodes)};return s.nodes=function(){return i.forEach(p=>{f(a,p.bind(this)())}),a},e.mixins.forEach(p=>{y(D(p))}),y(e),s}var A={directives(e){let t=this.nodeElement;if(!e.startsWith("_"))return d(t.nodepath,102,e);let r=this.context.directives[e],o=this.nodeOptions[e],{create:n,update:s,destroy:i}=r;Object.assign(t.directives,{[e]:{create:()=>n?n.bind(r)(t.target,o):{},destroy:()=>i?i.bind(r)(t.target,o):{}}}),n&&t.directives[e].create();let a=(c,u,f)=>{let y=p=>s.bind(r)(t.target,p,u,f);typeof c=="function"?(this.impress.collect=!0,y(c(t.target)),this.reactiveNode(this.impress.define(),()=>y(c(t.target)))):y(c)};if(s)if(typeof o=="object")for(let c in o)a(o[c],c,o);else a(o)}};var M={listeners(e){typeof this.nodeOptions[e]=="function"&&(this.nodeElement.target[e]=t=>this.nodeOptions[e].bind(this.context)(t))},general(e){let t=r=>{this.nodeElement.target[e]!==null&&typeof this.nodeElement.target[e]=="object"?r!==null&&typeof r=="object"?Object.assign(this.nodeElement.target[e],r):d(this.nodeElement.nodepath,103,e):this.nodeElement.target[e]=r};if(typeof this.nodeOptions[e]=="function"){let r=()=>t(this.nodeOptions[e].bind(this.context)());this.impress.collect=!0,r(),this.reactiveNode(this.impress.define(),r)}else t(this.nodeOptions[e])},native(e){e.startsWith("on")?this.listeners(e):this.general(e)}};var G={async iterative(e){if(typeof e.iterate!="function")return l(this.nodeElement.nodepath,205);if(this.nodeElement.replaced)return l(this.nodeElement.nodepath,204);if(this.name=null,this.repeat=0,this.nodeElement.children=[],this.nodeOptions.component=e,this.nodeElement.clear=()=>this.length.bind(this)(0),this.createIterate=async t=>{this.nodeElement.children[t]=this.nodeElement._current={parent:this.nodeElement,target:!0,nodepath:this.nodeElement.nodepath+"."+t,index:t,iterated:!0},await this.create(this.proxiesIterate.bind(this),this.nodeElement._current,e)},this.impress.collect=!0,this.data=e.iterate(),this.data){if(!Array.isArray(this.data))return l(this.nodeElement.nodepath,205);this.name=this.impress.refs.at(-1),this.impress.clear(),Object.getPrototypeOf(this.data).instance==="Proxy"&&(this.reactiveComponent([this.name],o=>this.length(o.length)),this.reactiveComponent([this.name+".length"],o=>this.length(o)));let t=async()=>{this.data=e.iterate(),await this.length(this.data.length)};this.induced(async o=>o?await t():this.nodeElement.clear())&&await t()}},proxiesIterate(e){let t=this.nodeElement._current,r=(o,n)=>{this.impress.refs.some(s=>s.includes(this.name))?this.reactiveComponent(this.impress.define(o),(s,i)=>{let a=(...c)=>t.proxy?.[o]?.setValue(...c);i?a(s,i):a(n(t))}):this.nodeElement.created?this.impress.clear():this.reactiveComponent(this.impress.define(o),(s,i)=>{let a=this.nodeElement.children,c=u=>{let f=a[u],y=(...p)=>f.proxy?.[o]?.setValue(...p);i?y(s,i):y(n(f))};this.portions(a.length,0,c),this.repeat++})};return this.reactivate(e,r,t)},async portions(e,t,r){if(!e)return;let{portion:o}=this.nodeOptions.component,n=null,s=!1;if(t<e-o){let i=()=>{if(this.repeat>1)return this.repeat--;this.portions(e,t,r)};setTimeout(()=>s?i():new Promise(a=>n=a).then(a=>i()))}do if(await r(t),t++,n&&(o=1),t>=e){this.repeat=0;break}while(t%o!==0);s=!0,n?.()},async length(e){this.repeat++;let t=this.nodeElement.children.length;if(e>t&&await this.portions(e,t,async r=>await this.createIterate(r)),e<t)for(;e<t;){t--;let r=this.nodeElement.children;j(this.nodeElement.reactivity.component,this.name+"."+t),r[t].unmount?.(),r[t].target.remove?.(),r.splice(t,1)}}};var K={async basic(e){this.nodeOptions.component=e;let t=()=>this.create(this.proxies.bind(this),this.nodeElement,e);this.induced(async o=>o?await t():this.nodeElement.unmount?.())&&await t()},proxies(e){if(!e)return;let t=(r,o)=>this.reactiveComponent(this.impress.define(r),(n,s)=>{let i=(...a)=>this.nodeElement.proxy?.[r]?.setValue(...a);s?i(n,s):i(o(this.nodeElement))});return this.reactivate(e,t)}};var Q={collect(e,t){return{params:this.params(e.params,t),methods:this.methods(e.methods)}},methods(e){let t={};if(e)for(let[r,o]of Object.entries(e))typeof o=="function"&&Object.assign(t,{[r]:o});return t},params(e,t){let r={};if(e)for(let[o,n]of Object.entries(e))Object.assign(r,{[o]:typeof n=="function"&&n.name?n(t):n});return r}};var X={async component(){if(this.nodeElement.reactivity.component=new Map,this.nodeElement.iterated)return l(this.nodeElement.nodepath,208);this.nodeElement.mount=t=>(this.nodeElement.unmount?.(),this.nodeElement.created=!1,t.iterate?this.iterative(t):this.basic(t));let e=()=>this.nodeElement.mount(this.nodeOptions.component);this.nodeOptions.component.async?e():await e()},induced(e){if(this.nodeOptions.component.hasOwnProperty("induce")){this.nodeElement.induce=e;let t=this.nodeOptions.component.induce;if(!t)return;if(typeof t=="function"){this.impress.collect=!0;let r=t();if(this.reactiveNode(this.impress.define(),async()=>await this.nodeElement.induce(t())),!r)return}}return!0},reactiveComponent(e,t){return this.reactive(e,t,this.nodeElement.reactivity.component)},reactivate(e,t){let r={};if(e)for(let[o,n]of Object.entries(e))if(typeof n=="function"&&n.name){this.impress.collect=!0;let s=c=>n(c),i=n(this.nodeElement._current||this.nodeElement),a=t(o,s);Object.assign(r,{[o]:{_value:i,_independent:!a}})}else Object.assign(r,{[o]:{_value:n,_independent:!0}});return r},async create(e,t,r){let{src:o,spots:n,aborted:s,completed:i}=r;if(o&&(await T(o,t,{aborted:s,completed:i,...Q.collect(r,t),proxies:e(r.proxies)||{}},this.app),this.nodeElement.created=!0,!!n))for await(let[a,c]of Object.entries(n)){if(!t.spot?.hasOwnProperty(a)){l(t.nodepath,202,a);continue}let u=t.spot[a];Object.assign(u,{parent:t,nodepath:t.nodepath+"."+a,nodename:a,spoted:!0}),await R(c,this.context,u,this.impress,this.app).controller()}}};var b=class{constructor(t,r,o,n,s){this.app=s,this.nodeOptions=t,this.context=r,this.impress=n,this.nodeElement=o,this.nodeElement.reactivity={node:new Map}}reactive(t,r,o){return t?.length&&o.set(r,t),this.impress.clear(),t}reactiveNode(t,r){this.reactive(t,r,this.nodeElement.reactivity.node)}controller(){let t=this.nodeElement.nodepath,r=this.nodeElement.target.tagName==="TEMPLATE";this.nodeElement.replaced=r;for(let o in this.nodeOptions){if(r&&!["selector","component"].includes(o))return d(t,108,o);if(o in this.nodeElement.target)this.native(o);else if(o in this.context.directives)this.directives(o);else{if(o==="component")return this.component?.();d(t,104,o)}}}};function R(...e){return Object.assign(b.prototype,M,A,G,K,X),new b(...e)}function C(e,t){let r=typeof e=="function"?e.bind(t)():e;return P(r)}function q(e,t){let r={...t.context.options},o=s=>{if(!s)return l(e.nodepath,210);let i=C(s,t.context);return i.length>1?l(e.nodepath,210):i},n=s=>{r.spots?.length&&(s.spot={}),r.spots?.forEach(i=>Object.assign(s.spot,{[i]:{target:s.target.querySelector(`[spot="${i}"]`)}}))};if(e.iterated){let s=e.parent;s.children.length===1&&s.target.childNodes.length&&(s.target.innerHTML="");let i=o(r.template);s.target.append(...i),e.target=s.target.lastChild,n(e),s.unmount||(s.unmount=()=>{t.destroy(s),s.clear()}),e.unmount=()=>{t.destroy(e),t.unmount(e),t.context.abort()}}else{if(e.replaced){let s=o(r.template),i=e.target;e.target.before(...s),e.target=i.previousSibling,i.remove()}else{if(!r.template)return;let s=C(r.template,t.context);e.target.innerHTML="",e.target.append(...s)}n(e),e.unmount=()=>{t.destroy(e),t.unmount(e),e.target.innerHTML="",t.context.abort()}}}async function S(e,t,r,o,n){let s=[async()=>await e.loaded(r),async()=>{await e.props(r),e.params(),e.methods(),e.proxies(),await e.created()},async()=>{t(),await e.rendered()},async()=>{await e.nodes(),await e.mounted()}];try{for await(let i of s)await w(i(),e.context.abortSignal),e.context.phase++}catch{o()}return n?.(),e.context.container}async function T(e,t,r={},o={}){let n=new AbortController;t.unmount=()=>n.abort();let s=()=>r.aborted?.({phase:a?a.context.phase:0,reason:n.signal.reason}),i=await g(e,n.signal,s);if(!i)return l(t.nodepath,216);let a=new _(D(i),t,o,n,R);return await S(a,()=>q(t,a),r,s,r.completed)}function k(e={}){let t={};return e.mount=async({options:r,target:o,name:n="root"},s)=>(Object.assign(t,{target:o,nodepath:n}),await T(r,{target:o,nodepath:n},s,e)),e.unmount=()=>t.unmount?.(),Object.preventExtensions(e),e}function Z(...e){return Object.assign(b.prototype,M,A),new b(...e)}async function W({options:e,target:t,name:r="root",completed:o,aborted:n},s={}){if(!e)return l(r,216);if(!t)return l(r,217);let i={...e},a=new AbortController,c={target:t,nodepath:r,unmount(){a.abort(),t.innerHTML=""}},u=new N(i,c,s,a,Z);return await S(u,()=>{u.context.container=c,i.template&&t.append(...C(i.template,u.context))},{},()=>n?.({phase:u.context.phase,reason:a.signal.reason}),o)}window.lesta={createApp:k,mountWidget:W,replicate:m,deliver:v,deleteReactive:j,cleanHTML:P,loadModule:g,revocablePromise:w};})();
